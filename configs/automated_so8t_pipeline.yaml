# SO8T統合自動パイプライン設定

# パイプライン全体設定
pipeline:
  name: "SO8T統合自動パイプライン"
  output_base_dir: "D:/webdataset"
  checkpoint_dir: "D:/webdataset/pipeline_checkpoints"
  resume: true  # チェックポイントから再開可能

# Phase 1: Webスクレイピングとデータ収集
phase1_web_scraping:
  enabled: true
  use_existing_pipeline: true  # 既存のcomplete_data_pipeline.pyを使用
  pipeline_config: "configs/data_pipeline_config.yaml"
  output_dir: "D:/webdataset/processed/finetuning"
  target_samples: 100000  # 目標サンプル数
  # 既存パイプラインの設定を継承

# Phase 2: データクレンジングと前処理
phase2_data_cleansing:
  enabled: true
  use_existing_pipeline: true  # 既存パイプラインを使用
  # 既存パイプラインで自動的にクレンジングされる

# Phase 3: modeling_phi3.pyのSO8T統合
phase3_modeling_so8t:
  enabled: true
  modeling_file: "models/Borea-Phi-3.5-mini-Instruct-Jp/modeling_phi3_so8t.py"
  # 既に実装済み

# Phase 4: SO8T統合スクリプト
phase4_integration:
  enabled: true
  script: "scripts/conversion/integrate_phi3_so8t.py"
  model_path: "models/Borea-Phi-3.5-mini-Instruct-Jp"
  output_path: "D:/webdataset/models/so8t_integrated/phi3_so8t"
  device: "cuda"
  verify: true
  torch_dtype: "bfloat16"

# Phase 5: QLoRA 8bitファインチューニング
phase5_qlora_training:
  enabled: true
  script: "scripts/training/train_so8t_phi3_qlora.py"
  config: "configs/train_so8t_phi3_qlora.yaml"
  resume: false  # 最初から開始
  # 設定ファイルで詳細を指定

# 各フェーズの依存関係
dependencies:
  phase2_data_cleansing:
    - phase1_web_scraping
  phase4_integration:
    - phase3_modeling_so8t
  phase5_qlora_training:
    - phase4_integration
    - phase2_data_cleansing

# エラーハンドリング
error_handling:
  max_retries: 3
  retry_delay: 60  # 秒
  continue_on_error: false  # エラー時に停止

# ログ設定
logging:
  level: "INFO"
  log_file: "D:/webdataset/pipeline_logs/automated_so8t_pipeline.log"
  log_interval: 300  # 5分間隔でログ

# Phase 7: 評価・変換・デプロイ
phase7_evaluation_deployment:
  enabled: true
  
  # Phase 7.1: 実行テスト
  phase7_1_testing:
    enabled: true
    test_script: "scripts/testing/test_so8t_pipeline_components.py"
    run_unit_tests: true
    run_integration_tests: true
  
  # Phase 7.2: モデル評価
  phase7_2_evaluation:
    enabled: true
    eval_script: "scripts/evaluation/evaluate_so8t_phi3.py"
    eval_dataset: "D:/webdataset/processed/finetuning/eval.jsonl"
  
  # Phase 7.3: GGUF変換
  phase7_3_gguf_conversion:
    enabled: true
    convert_script: "external/llama.cpp-master/convert_hf_to_gguf.py"
    quantizations: ["f16", "q8_0"]
    output_dir: "D:/webdataset/gguf_models"
  
  # Phase 7.4: Ollamaインポート
  phase7_4_ollama_import:
    enabled: true
    model_name: "so8t-phi3"
    modelfile_dir: "modelfiles"
  
  # Phase 7.5: 日本語パフォーマンステスト
  phase7_5_japanese_test:
    enabled: true
    test_script: "scripts/testing/japanese_llm_performance_test.py"
    output_dir: "_docs"

# 通知設定
notifications:
  audio_notification: true
  audio_file: "C:/Users/downl/Desktop/SO8T/.cursor/marisa_owattaze.wav"
  play_on_completion: true
  play_on_error: true

