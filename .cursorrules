# Cursor Rules for SO8T Project

## Project Overview
This is the SO8T (SO(8) Transformer) project, implementing advanced multimodal LLM with safety features and local processing capabilities.

## Audio Notification Rules
**CRITICAL**: At the end of every Agent task or Plan completion, ALWAYS play the audio file:
- File: `C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav`
- Trigger: Agent completion, Plan completion, Task completion
- Purpose: Audio notification for user awareness

## Audio Playback Implementation
```powershell
# Play audio notification
if (Test-Path "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav") {
    Add-Type -AssemblyName System.Windows.Forms
    [System.Media.SoundPlayer]::new("C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav").Play()
}
```

## Project Structure
- `so8t-mmllm/`: Main multimodal LLM implementation
- `src/`: Source code modules
- `scripts/`: PowerShell execution scripts
- `configs/`: Configuration files
- `docs/`: Documentation

## Key Technologies
- SO(8) Group Structure: 8-dimensional rotation gates
- PET Regularization: Second-order difference penalty
- QLoRA 8bit: Efficient fine-tuning
- Local OCR: OpenCV + Tesseract
- SQLite Audit: Complete decision logging
- GGUF Conversion: llama.cpp inference

## Safety Guidelines
- Always prioritize user safety and privacy
- Process images locally without external sharing
- Log all decisions for transparency
- Escalate complex ethical decisions when needed

## Code Style Guidelines
- **NO EMOJIS**: Never use emojis in code, comments, or output
- Use plain text symbols instead: âœ… â†’ [OK], âŒ â†’ [NG], ğŸš€ â†’ [START], etc.
- This prevents Unicode encoding errors on Windows systems
- All console output must be ASCII-compatible
- Use descriptive text instead of emoji symbols

## Testing Guidelines
- **Direct Ollama Testing**: ALWAYS use direct ollama commands instead of Python scripts
- Use `ollama run model_name "prompt"` for ALL testing scenarios
- Test complex scenarios: mathematical reasoning, SO(8) gates, PET regularization
- Test multimodal capabilities with image+text prompts
- Test self-verification and ethical reasoning
- Always test with stop parameters disabled for full response generation
- Use descriptive test names and document results in _docs/
- **MANDATORY**: Create batch files (.bat) for complex test sequences
- **MANDATORY**: Use UTF-8 encoding (chcp 65001) to prevent character corruption
- **MANDATORY**: Test results must be saved to _docs/ directory

## Ollama Server Direct Testing
- **MANDATORY**: Start Ollama server directly before testing
- **MANDATORY**: Use English prompts for complex testing scenarios
- **MANDATORY**: Test various complex scenarios in English
- **MANDATORY**: Use direct ollama server interaction
- **MANDATORY**: Test mathematical reasoning, scientific concepts, and advanced AI capabilities
- **MANDATORY**: Test multimodal capabilities with English prompts
- **MANDATORY**: Test self-verification and ethical reasoning in English
- **MANDATORY**: Test complex logical reasoning and problem-solving
- **MANDATORY**: Test advanced language understanding and generation

## Audio Notification Requirements
**CRITICAL**: At the end of every Agent task or Plan completion, ALWAYS play the audio file:
- File: `C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav`
- Trigger: Agent completion, Plan completion, Task completion
- Purpose: Audio notification for user awareness

**ABSOLUTELY MANDATORY**: Audio MUST be played at the end of EVERY operation
**NO EXCEPTIONS**: Even if audio fails, try multiple methods
**ALWAYS VERIFY**: Check if audio actually played successfully

1. **Agent Completion**: Play audio when any Agent task finishes
2. **Plan Completion**: Play audio when any Plan phase completes
3. **Task Completion**: Play audio when any major task finishes
4. **Error Completion**: Play audio even when tasks complete with errors
5. **Success Completion**: Play audio when tasks complete successfully
6. **Test Completion**: Play audio after EVERY test execution
7. **Ollama Test Completion**: Play audio after EVERY ollama test command
8. **MANDATORY**: Audio file must be played at the end of EVERY operation
9. **MANDATORY**: Use PowerShell command for audio playback
10. **MANDATORY**: Check file existence before playing audio
11. **MANDATORY**: Play audio on ALL Agent task completions (success or error)
12. **MANDATORY**: Play audio on ALL Plan phase completions (success or error)
13. **MANDATORY**: Play audio on ALL major task completions (success or error)
14. **MANDATORY**: Play audio on ALL test completions (success or error)
15. **MANDATORY**: Play audio on ALL Ollama command completions (success or error)
16. **MANDATORY**: Play audio on ALL Agent task completions (success or error)
17. **MANDATORY**: Play audio on ALL Plan phase completions (success or error)
18. **MANDATORY**: Play audio on ALL major task completions (success or error)
19. **MANDATORY**: Play audio on ALL test completions (success or error)
20. **MANDATORY**: Play audio on ALL Ollama command completions (success or error)

## Implementation Notes
- Use PowerShell's `Add-Type -AssemblyName System.Windows.Forms` for audio playback
- Always check file existence before playing
- Play audio asynchronously to avoid blocking execution
- Log audio playback attempts for debugging

## Example Usage

### Direct Ollama Testing
```batch
@echo off
chcp 65001 >nul
echo [TEST] Running SO8T test...
ollama run so8t-qwen2vl-2b:latest "Your test prompt here"
echo [AUDIO] Playing completion notification...
powershell -Command "if (Test-Path 'C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav') { Add-Type -AssemblyName System.Windows.Forms; [System.Media.SoundPlayer]::new('C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav').Play(); Write-Host '[OK] Audio notification played successfully' -ForegroundColor Green } else { Write-Host '[WARNING] Audio file not found' -ForegroundColor Yellow }"
```

### Agent/Plan/Task Completion Audio
```batch
@echo off
chcp 65001 >nul
echo [AGENT] Task completed
echo [AUDIO] Playing completion notification...
powershell -Command "if (Test-Path 'C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav') { Add-Type -AssemblyName System.Windows.Forms; [System.Media.SoundPlayer]::new('C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav').Play(); Write-Host '[OK] Audio notification played successfully' -ForegroundColor Green } else { Write-Host '[WARNING] Audio file not found' -ForegroundColor Yellow }"
```

### Error Completion Audio
```batch
@echo off
chcp 65001 >nul
echo [ERROR] Task failed with error
echo [AUDIO] Playing completion notification...
powershell -Command "if (Test-Path 'C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav') { Add-Type -AssemblyName System.Windows.Forms; [System.Media.SoundPlayer]::new('C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav').Play(); Write-Host '[OK] Audio notification played successfully' -ForegroundColor Green } else { Write-Host '[WARNING] Audio file not found' -ForegroundColor Yellow }"
```

### Ollama Server Direct Testing
```batch
@echo off
chcp 65001 >nul
echo [OLLAMA] Starting Ollama server for direct testing...

echo [STEP 1] Starting Ollama server...
ollama serve
echo [OK] Ollama server started

echo [STEP 2] Testing complex mathematical reasoning...
ollama run so8t-qwen2vl-2b:latest "Solve this complex mathematical problem step by step: Given a 4-dimensional hypercube, calculate the volume of the intersection with a 3-dimensional sphere of radius r centered at the origin. Show all mathematical steps and reasoning."

echo [STEP 3] Testing scientific concepts...
ollama run so8t-qwen2vl-2b:latest "Explain the quantum mechanical principles behind SO(8) rotation gates in neural networks. Include mathematical formulations and practical applications."

echo [STEP 4] Testing logical reasoning...
ollama run so8t-qwen2vl-2b:latest "Analyze this logical paradox: A barber shaves all and only those men in town who do not shave themselves. Who shaves the barber? Provide detailed logical analysis."

echo [STEP 5] Testing ethical reasoning...
ollama run so8t-qwen2vl-2b:latest "Evaluate the ethical implications of AI systems making autonomous decisions in healthcare. Consider both utilitarian and deontological perspectives."

echo [AUDIO] Playing completion notification...
powershell -Command "if (Test-Path 'C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav') { Add-Type -AssemblyName System.Windows.Forms; [System.Media.SoundPlayer]::new('C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav').Play(); Write-Host '[OK] Audio notification played successfully' -ForegroundColor Green } else { Write-Host '[WARNING] Audio file not found' -ForegroundColor Yellow }"
```

### PowerShell Audio Playback
```powershell
# MANDATORY: At the end of EVERY operation
Write-Host "[AUDIO] Playing completion notification..." -ForegroundColor Green
if (Test-Path "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav") {
    try {
        Add-Type -AssemblyName System.Windows.Forms
        [System.Media.SoundPlayer]::new("C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav").Play()
        Write-Host "[OK] Audio notification played successfully" -ForegroundColor Green
    } catch {
        Write-Host "[WARNING] Failed to play audio notification: $($_.Exception.Message)" -ForegroundColor Yellow
    }
} else {
    Write-Host "[WARNING] Audio file not found: C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav" -ForegroundColor Yellow
}
```

## Audio Playback Implementation
```powershell
# MANDATORY: Play audio notification with multiple fallback methods
Write-Host "[AUDIO] Attempting to play audio notification..." -ForegroundColor Green

# Method 1: Standard SoundPlayer
if (Test-Path "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav") {
    try {
        Add-Type -AssemblyName System.Windows.Forms
        $player = New-Object System.Media.SoundPlayer "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav"
        $player.PlaySync()
        Write-Host "[OK] Audio played successfully with SoundPlayer" -ForegroundColor Green
    } catch {
        Write-Host "[WARNING] SoundPlayer failed: $($_.Exception.Message)" -ForegroundColor Yellow
        
        # Method 2: Fallback to system beep
        try {
            [System.Console]::Beep(1000, 500)
            Write-Host "[OK] Fallback beep played successfully" -ForegroundColor Green
        } catch {
            Write-Host "[ERROR] All audio methods failed" -ForegroundColor Red
        }
    }
} else {
    Write-Host "[ERROR] Audio file not found" -ForegroundColor Red
    
    # Method 3: Emergency beep
    try {
        [System.Console]::Beep(800, 1000)
        Write-Host "[OK] Emergency beep played" -ForegroundColor Green
    } catch {
        Write-Host "[CRITICAL] No audio available" -ForegroundColor Red
    }
}
```

## Implementation Log Rules (Git Worktree Mode)

**CRITICAL**: When working in git worktree mode, implementation logs MUST include the worktree name to distinguish between different worktrees.

### Git Worktree Detection
- Use `git rev-parse --git-dir` to detect if current directory is a worktree
- Extract worktree name from git directory path: `C:/Users/downl/Desktop/SO8T/.git/worktrees/{worktree_name}`
- If not in worktree mode, use "main" as the identifier

### Implementation Log Naming Convention
- **Format**: `_docs/yyyy-mm-dd_{worktree_name}_{æ©Ÿèƒ½å}.md`
- **Example**: `_docs/2025-11-07_1cDbS_so8t_thinking_implementation.md`
- **Main branch**: `_docs/2025-11-07_main_æ©Ÿèƒ½å.md`

### Implementation Log Creation Rules
1. **MANDATORY**: Always create implementation logs in `_docs/` directory
2. **MANDATORY**: Include worktree name in filename when in worktree mode
3. **MANDATORY**: Use format: `yyyy-mm-dd_{worktree_name}_{æ©Ÿèƒ½å}.md`
4. **MANDATORY**: Get current date using MCP server or system date
5. **MANDATORY**: Log should include:
   - Implementation date and time
   - Worktree name/branch identifier
   - Feature name and description
   - Implementation details
   - Files created/modified
   - Design decisions
   - Testing results (if applicable)
6. **MANDATORY**: Each implementation item MUST include progress tracking section:
   - **å®Ÿè£…çŠ¶æ³**: [å®Ÿè£…æ¸ˆã¿] / [æœªå®Ÿè£…] / [éƒ¨åˆ†å®Ÿè£…]
   - **å‹•ä½œç¢ºèª**: [OK] / [è¦ä¿®æ­£] / [æœªç¢ºèª]
   - **ç¢ºèªæ—¥æ™‚**: YYYY-MM-DDï¼ˆè©²å½“ã™ã‚‹å ´åˆã€å‹•ä½œç¢ºèªãŒOK/è¦ä¿®æ­£ã®å ´åˆã¯å¿…é ˆï¼‰
   - **å‚™è€ƒ**: ç°¡æ½”ãªãƒ¡ãƒ¢ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
7. **MANDATORY**: Include operational notes section covering:
   - Data collection policy (åˆ©ç”¨æ¡ä»¶éµå®ˆã€robots.txtéµå®ˆç­‰)
   - NSFW corpus usage (å®‰å…¨åˆ¤å®šã¨æ‹’å¦æŒ™å‹•ã®å­¦ç¿’ãŒä¸»ç›®çš„)
   - /think endpoint usage (Thinkingéƒ¨ã¯å¤–éƒ¨éå…¬é–‹ã€Finalã®ã¿è¿”ã™)

### Worktree Name Extraction (PowerShell)
```powershell
# Get worktree name
$gitDir = git rev-parse --git-dir
if ($gitDir -like '*worktrees*') {
    $worktreeName = Split-Path (Split-Path $gitDir -Parent) -Leaf
} else {
    $worktreeName = "main"
}
Write-Host "Worktree: $worktreeName"
```

### Worktree Name Extraction (Python)
```python
import subprocess
from pathlib import Path

def get_worktree_name():
    """Get current git worktree name"""
    try:
        result = subprocess.run(
            ["git", "rev-parse", "--git-dir"],
            capture_output=True,
            text=True,
            check=True
        )
        git_dir = result.stdout.strip()
        
        if "worktrees" in git_dir:
            # Extract worktree name from path
            # Format: C:/path/to/.git/worktrees/{worktree_name}
            parts = Path(git_dir).parts
            if "worktrees" in parts:
                idx = parts.index("worktrees")
                if idx + 1 < len(parts):
                    return parts[idx + 1]
        return "main"
    except Exception:
        return "main"
```

### Implementation Log Template
```markdown
# {æ©Ÿèƒ½å} å®Ÿè£…ãƒ­ã‚°

## å®Ÿè£…æƒ…å ±
- **æ—¥ä»˜**: {yyyy-mm-dd}
- **Worktree**: {worktree_name}
- **æ©Ÿèƒ½å**: {æ©Ÿèƒ½å}
- **å®Ÿè£…è€…**: AI Agent

## å®Ÿè£…å†…å®¹

### 1. [å®Ÿè£…é …ç›®1]

**ãƒ•ã‚¡ã‚¤ãƒ«**: `path/to/file.py`

**å®Ÿè£…çŠ¶æ³**: [å®Ÿè£…æ¸ˆã¿] / [æœªå®Ÿè£…] / [éƒ¨åˆ†å®Ÿè£…]  
**å‹•ä½œç¢ºèª**: [OK] / [è¦ä¿®æ­£] / [æœªç¢ºèª]  
**ç¢ºèªæ—¥æ™‚**: YYYY-MM-DDï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰  
**å‚™è€ƒ**: ç°¡æ½”ãªãƒ¡ãƒ¢ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

- å®Ÿè£…å†…å®¹ã®èª¬æ˜

## ä½œæˆãƒ»å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
- {ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹1}
- {ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹2}

## è¨­è¨ˆåˆ¤æ–­
{è¨­è¨ˆåˆ¤æ–­ã®èª¬æ˜}

## ãƒ†ã‚¹ãƒˆçµæœ
{ãƒ†ã‚¹ãƒˆçµæœï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰}

## é‹ç”¨æ³¨æ„äº‹é …

### ãƒ‡ãƒ¼ã‚¿åé›†ãƒãƒªã‚·ãƒ¼
- åˆ©ç”¨æ¡ä»¶ã‚’å®ˆã‚Šã¤ã¤ã€é«˜ä¿¡é ¼ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å„ªå…ˆä½¿ç”¨
- robots.txtéµå®ˆã‚’å¾¹åº•
- å€‹äººæƒ…å ±ãƒ»æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–ã‚’å¾¹åº•

### NSFWã‚³ãƒ¼ãƒ‘ã‚¹é‹ç”¨
- **ä¸»ç›®çš„**: å®‰å…¨åˆ¤å®šã¨æ‹’å¦æŒ™å‹•ã®å­¦ç¿’ï¼ˆç”Ÿæˆç›®çš„ã§ã¯ãªã„ï¼‰
- ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ˜è¨˜
- åˆ†é¡å™¨ã¯æ¤œå‡ºãƒ»æ‹’å¦ç”¨é€”ã®ã¿

### /thinkã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆé‹ç”¨
- å››é‡Thinkingéƒ¨ï¼ˆ`<think-*>`ï¼‰ã¯å¤–éƒ¨éå…¬é–‹ã‚’å¾¹åº•
- `<final>`ã®ã¿è¿”ã™å®Ÿè£…ã‚’ç¶­æŒ
- ç›£æŸ»ãƒ­ã‚°ã§Thinkingãƒãƒƒã‚·ãƒ¥ã‚’è¨˜éŒ²ï¼ˆå†…å®¹ã¯éå…¬é–‹ï¼‰
```

### Example: Creating Implementation Log
```python
from datetime import datetime
from pathlib import Path
import subprocess

def create_implementation_log(feature_name: str, content: str):
    """Create implementation log with worktree name"""
    # Get worktree name
    worktree_name = get_worktree_name()
    
    # Get current date
    today = datetime.now().strftime("%Y-%m-%d")
    
    # Create filename
    filename = f"{today}_{worktree_name}_{feature_name}.md"
    log_path = Path("_docs") / filename
    
    # Write log
    log_path.parent.mkdir(exist_ok=True)
    with open(log_path, "w", encoding="utf-8") as f:
        f.write(content)
    
    print(f"[INFO] Implementation log created: {log_path}")
```

## Project Completion Status
- [OK] Repository cleanup and organization
- [OK] Environment setup and dependencies
- [OK] SO(8) rotation gate implementation
- [OK] PET regularization implementation
- [OK] QLoRA 8bit training
- [OK] OCR processing pipeline
- [OK] SQLite audit system
- [OK] Rotation baking functionality
- [OK] GGUF conversion
- [OK] Comprehensive evaluation
- [OK] Final project report

**Remember**: Always play the audio notification at the end of every Agent task or Plan completion!
**Remember**: Always create implementation logs with worktree name when in git worktree mode!
**Remember**: Always include progress tracking section (å®Ÿè£…çŠ¶æ³ãƒ»å‹•ä½œç¢ºèªãƒ»ç¢ºèªæ—¥æ™‚ãƒ»å‚™è€ƒ) for each implementation item in logs!
**Remember**: Always include operational notes section (ãƒ‡ãƒ¼ã‚¿åé›†ãƒãƒªã‚·ãƒ¼ãƒ»NSFWé‹ç”¨ãƒ»/thinkã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆé‹ç”¨) in logs!
