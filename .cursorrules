# Cursor Rules for SO8T Project

## Project Overview
This is the SO8T (SO(8) Transformer) project, implementing advanced multimodal LLM with safety features and local processing capabilities.

## Audio Notification Rules
**CRITICAL**: At the end of every Agent task or Plan completion, ALWAYS play the audio file:
- **Primary**: `C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav` (åŸºæœ¬ã¯ã“ã‚Œã‚’å†ç”Ÿ)
- **Fallback**: ãƒ”ãƒ¼ãƒ—éŸ³ï¼ˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå†ç”Ÿã§ããªã„å ´åˆï¼‰
- Trigger: Agent completion, Plan completion, Task completion
- Purpose: Audio notification for user awareness

**BASIC PRINCIPLE**: Always try to play `marisa_owattaze.wav` first. If it fails, play a beep sound as fallback.

## Audio Playback Implementation
```powershell
# MANDATORY: Play marisa_owattaze.wav first, fallback to beep if it fails
Write-Host "[AUDIO] Playing completion notification..." -ForegroundColor Green
$audioFile = "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav"
$audioPlayed = $false

# Method 1: Try to play marisa_owattaze.wav (PRIMARY METHOD)
if (Test-Path $audioFile) {
    try {
        Add-Type -AssemblyName System.Windows.Forms
        $player = New-Object System.Media.SoundPlayer $audioFile
        $player.PlaySync()
        Write-Host "[OK] marisa_owattaze.wav played successfully" -ForegroundColor Green
        $audioPlayed = $true
    } catch {
        Write-Host "[WARNING] Failed to play marisa_owattaze.wav: $($_.Exception.Message)" -ForegroundColor Yellow
    }
} else {
    Write-Host "[WARNING] marisa_owattaze.wav not found: $audioFile" -ForegroundColor Yellow
}

# Method 2: Fallback to beep if marisa_owattaze.wav failed
if (-not $audioPlayed) {
    try {
        [System.Console]::Beep(1000, 500)
        Write-Host "[OK] Fallback beep played successfully" -ForegroundColor Green
    } catch {
        Write-Host "[ERROR] All audio methods failed" -ForegroundColor Red
    }
}
```

## Project Structure
- `so8t-mmllm/`: Main multimodal LLM implementation
- `src/`: Source code modules
- `scripts/`: PowerShell execution scripts
- `configs/`: Configuration files
- `docs/`: Documentation

## Key Technologies
- SO(8) Group Structure: 8-dimensional rotation gates
- PET Regularization: Second-order difference penalty
- QLoRA 8bit: Efficient fine-tuning
- Local OCR: OpenCV + Tesseract
- SQLite Audit: Complete decision logging
- GGUF Conversion: llama.cpp inference

## Model Checkpoint and Output Directory
**MANDATORY**: All model checkpoints and outputs must be saved to `D:\webdataset`

### Checkpoint Save Locations
- **GGUF Conversion Output**: `D:\webdataset\gguf_models\`
- **Training Checkpoints**: `D:\webdataset\checkpoints\training\`
- **Fine-tuning Checkpoints**: `D:\webdataset\checkpoints\finetuning\`
- **Model Weights**: `D:\webdataset\weights\`
- **Final Models**: `D:\webdataset\models\final\`

### Implementation Requirements
1. **GGUF Conversion**: After GGUF conversion, save output files to `D:\webdataset\gguf_models\{model_name}\`
2. **Training**: Save all training checkpoints to `D:\webdataset\checkpoints\training\{run_name}\`
3. **Fine-tuning**: Save all fine-tuning checkpoints to `D:\webdataset\checkpoints\finetuning\{model_name}\`
4. **Model Weights**: Save intermediate and final model weights to `D:\webdataset\weights\`
5. **Final Models**: Save completed models to `D:\webdataset\models\final\{model_name}\`

### Directory Structure
```
D:\webdataset\
â”œâ”€â”€ gguf_models\          # GGUFå¤‰æ›å¾Œã®ãƒ¢ãƒ‡ãƒ«
â”‚   â””â”€â”€ {model_name}\
â”‚       â”œâ”€â”€ {model_name}_Q8_0.gguf
â”‚       â””â”€â”€ {model_name}_Q4_K_M.gguf
â”œâ”€â”€ checkpoints\          # ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ training\         # å­¦ç¿’ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ {run_name}\
â”‚   â”‚       â”œâ”€â”€ checkpoint_epoch_{N}.pt
â”‚   â”‚       â””â”€â”€ checkpoint_final.pt
â”‚   â””â”€â”€ finetuning\       # ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ
â”‚       â””â”€â”€ {model_name}\
â”‚           â”œâ”€â”€ checkpoint_epoch_{N}.pt
â”‚           â””â”€â”€ checkpoint_final.pt
â”œâ”€â”€ weights\              # ãƒ¢ãƒ‡ãƒ«é‡ã¿
â”‚   â”œâ”€â”€ {model_name}_epoch_{N}.pt
â”‚   â””â”€â”€ {model_name}_final.pt
â””â”€â”€ models\               # æœ€çµ‚ãƒ¢ãƒ‡ãƒ«
    â””â”€â”€ final\
        â””â”€â”€ {model_name}\
            â”œâ”€â”€ model.pt
            â”œâ”€â”€ config.json
            â””â”€â”€ tokenizer.json
```

### Code Examples

#### GGUF Conversion
```python
# Save GGUF output to D:\webdataset
output_dir = Path(r"D:\webdataset\gguf_models") / model_name
output_dir.mkdir(parents=True, exist_ok=True)
gguf_path = output_dir / f"{model_name}_{quantization}.gguf"
```

#### Training Checkpoint
```python
# Save training checkpoint to D:\webdataset
checkpoint_dir = Path(r"D:\webdataset\checkpoints\training") / run_name
checkpoint_dir.mkdir(parents=True, exist_ok=True)
checkpoint_path = checkpoint_dir / f"checkpoint_epoch_{epoch}.pt"
torch.save(checkpoint_data, checkpoint_path)
```

#### Fine-tuning Checkpoint
```python
# Save fine-tuning checkpoint to D:\webdataset
checkpoint_dir = Path(r"D:\webdataset\checkpoints\finetuning") / model_name
checkpoint_dir.mkdir(parents=True, exist_ok=True)
checkpoint_path = checkpoint_dir / f"checkpoint_epoch_{epoch}.pt"
torch.save(checkpoint_data, checkpoint_path)
```

#### Final Model Weights
```python
# Save final model weights to D:\webdataset
weights_dir = Path(r"D:\webdataset\weights")
weights_dir.mkdir(parents=True, exist_ok=True)
weights_path = weights_dir / f"{model_name}_final.pt"
torch.save(model.state_dict(), weights_path)
```

### Notes
- Always create directories if they don't exist using `mkdir(parents=True, exist_ok=True)`
- Use descriptive names for model directories (e.g., `so8t-phi4-ja-finetuned`)
- Include model metadata (config, tokenizer, etc.) alongside weights
- Log checkpoint save locations for easy retrieval

## Safety Guidelines
- Always prioritize user safety and privacy
- Process images locally without external sharing
- Log all decisions for transparency
- Escalate complex ethical decisions when needed

## Code Style Guidelines
- **NO EMOJIS**: Never use emojis in code, comments, or output
- Use plain text symbols instead: âœ… â†’ [OK], âŒ â†’ [NG], ğŸš€ â†’ [START], etc.
- This prevents Unicode encoding errors on Windows systems
- All console output must be ASCII-compatible
- Use descriptive text instead of emoji symbols

## Testing Guidelines
- **Direct Ollama Testing**: ALWAYS use direct ollama commands instead of Python scripts
- Use `ollama run model_name "prompt"` for ALL testing scenarios
- Test complex scenarios: mathematical reasoning, SO(8) gates, PET regularization
- Test multimodal capabilities with image+text prompts
- Test self-verification and ethical reasoning
- Always test with stop parameters disabled for full response generation
- Use descriptive test names and document results in _docs/
- **MANDATORY**: Create batch files (.bat) for complex test sequences
- **MANDATORY**: Use UTF-8 encoding (chcp 65001) to prevent character corruption
- **MANDATORY**: Test results must be saved to _docs/ directory

## A/B Test Post-Processing Workflow
**MANDATORY**: After A/B testing completion, convert winning model(s) to GGUF format and perform Japanese LLM performance testing with Ollama.

### Workflow Steps
1. **A/B Test Completion**: Wait for A/B test to complete and identify winning model
2. **GGUF Conversion**: Convert winning model(s) to GGUF format using `convert_hf_to_gguf.py`
3. **Ollama Import**: Import GGUF model to Ollama
4. **Japanese Performance Testing**: Run comprehensive Japanese LLM performance tests

### GGUF Conversion Process
**MANDATORY**: Use `external/llama.cpp-master/convert_hf_to_gguf.py` for conversion

#### Conversion Command
```bash
# Basic conversion (F16)
py external/llama.cpp-master/convert_hf_to_gguf.py \
    {model_dir} \
    --outfile D:/webdataset/gguf_models/{model_name}/{model_name}_f16.gguf \
    --outtype f16

# Quantized conversion (Q8_0)
py external/llama.cpp-master/convert_hf_to_gguf.py \
    {model_dir} \
    --outfile D:/webdataset/gguf_models/{model_name}/{model_name}_Q8_0.gguf \
    --outtype q8_0

# Quantized conversion (Q4_K_M)
py external/llama.cpp-master/convert_hf_to_gguf.py \
    {model_dir} \
    --outfile D:/webdataset/gguf_models/{model_name}/{model_name}_Q4_K_M.gguf \
    --outtype q4_k_m
```

#### Conversion Requirements
- **Input**: Hugging Face model directory (must contain `config.json`, `tokenizer.json`, model weights)
- **Output**: GGUF file saved to `D:/webdataset/gguf_models/{model_name}/`
- **Quantization Types**: f16 (full precision), q8_0 (8-bit), q4_k_m (4-bit medium)
- **MANDATORY**: Convert both F16 and at least one quantized version (Q8_0 or Q4_K_M)

### Ollama Import Process
**MANDATORY**: Import GGUF model to Ollama using `ollama create` command

#### Import Command
```bash
# Create Ollama model from GGUF file
ollama create {model_name}:latest -f {modelfile_path}

# Or import directly from GGUF (if supported)
ollama import {gguf_file_path}
```

#### Modelfile Template
```dockerfile
FROM D:/webdataset/gguf_models/{model_name}/{model_name}_Q8_0.gguf

TEMPLATE """{{ .System }}

{{ .Prompt }}"""

PARAMETER temperature 0.7
PARAMETER top_p 0.9
PARAMETER top_k 40
PARAMETER num_ctx 4096
```

### Japanese LLM Performance Testing
**MANDATORY**: After GGUF conversion and Ollama import, perform comprehensive Japanese performance testing

#### Test Categories
1. **æ—¥æœ¬èªç†è§£ãƒ†ã‚¹ãƒˆ**: æ—¥æœ¬èªã®æ–‡è„ˆç†è§£ã€èªå½™ç†è§£ã€æ§‹æ–‡è§£æ
2. **æ—¥æœ¬èªç”Ÿæˆãƒ†ã‚¹ãƒˆ**: è‡ªç„¶ãªæ—¥æœ¬èªç”Ÿæˆã€æ–‡ä½“ã®ä¸€è²«æ€§ã€æ•¬èªã®é©åˆ‡ãªä½¿ç”¨
3. **æ—¥æœ¬èªæ¨è«–ãƒ†ã‚¹ãƒˆ**: æ—¥æœ¬èªã§ã®è«–ç†çš„æ¨è«–ã€æ•°å­¦çš„å•é¡Œè§£æ±º
4. **æ—¥æœ¬èªå¯¾è©±ãƒ†ã‚¹ãƒˆ**: æ—¥æœ¬èªã§ã®ä¼šè©±èƒ½åŠ›ã€æ–‡è„ˆç¶­æŒã€å¿œç­”ã®é©åˆ‡æ€§
5. **å°‚é–€ç”¨èªãƒ†ã‚¹ãƒˆ**: æŠ€è¡“ç”¨èªã€å°‚é–€åˆ†é‡ã®çŸ¥è­˜ã€æ—¥æœ¬èªã§ã®èª¬æ˜èƒ½åŠ›

#### Test Script Template
```batch
@echo off
chcp 65001 >nul
echo [TEST] Japanese LLM Performance Testing
echo ========================================

echo [TEST 1] Japanese Understanding Test
ollama run {model_name}:latest "ä»¥ä¸‹ã®æ–‡ç« ã‚’èª­ã‚“ã§ã€å†…å®¹ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

[ãƒ†ã‚¹ãƒˆæ–‡ç« ]"

echo [TEST 2] Japanese Generation Test
ollama run {model_name}:latest "ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦ã€è‡ªç„¶ãªæ—¥æœ¬èªã§300æ–‡å­—ç¨‹åº¦ã®æ–‡ç« ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚

ãƒ†ãƒ¼ãƒ: äººå·¥çŸ¥èƒ½ã®æœªæ¥ã«ã¤ã„ã¦"

echo [TEST 3] Japanese Reasoning Test
ollama run {model_name}:latest "æ¬¡ã®å•é¡Œã‚’æ—¥æœ¬èªã§è§£ã„ã¦ãã ã•ã„ã€‚ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

å•é¡Œ: ã‚ã‚‹å•†å“ã®ä¾¡æ ¼ãŒ20ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå€¤ä¸‹ã’ã•ã‚Œã¾ã—ãŸã€‚å…ƒã®ä¾¡æ ¼ãŒ5000å††ã®å ´åˆã€å€¤ä¸‹ã’å¾Œã®ä¾¡æ ¼ã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ"

echo [TEST 4] Japanese Dialogue Test
ollama run {model_name}:latest "ä»¥ä¸‹ã®ä¼šè©±ã®ç¶šãã‚’ã€è‡ªç„¶ãªæ—¥æœ¬èªã§æ›¸ã„ã¦ãã ã•ã„ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã“ã‚“ã«ã¡ã¯ã€‚ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã™ã­ã€‚
ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ:"

echo [TEST 5] Technical Term Test
ollama run {model_name}:latest "ã€Œæ©Ÿæ¢°å­¦ç¿’ã€ã«ã¤ã„ã¦ã€å°‚é–€çš„ãªå†…å®¹ã‚’å«ã‚ãªãŒã‚‰ã€æ—¥æœ¬èªã§åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚"

echo [AUDIO] Playing completion notification...
powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"
```

#### Test Result Documentation
**MANDATORY**: Save test results to `_docs/` directory

- **File Format**: `_docs/yyyy-mm-dd_{worktree_name}_japanese_llm_performance_test_{model_name}.md`
- **Content**: Test prompts, model responses, evaluation scores, performance metrics
- **Evaluation Criteria**: Accuracy, fluency, coherence, appropriateness, technical accuracy

### Complete Workflow Example
```batch
@echo off
chcp 65001 >nul
echo [WORKFLOW] A/B Test Post-Processing
echo ====================================

echo [STEP 1] A/B Test completed, identifying winning model...
REM A/B test results should indicate which model performed better

echo [STEP 2] Converting winning model to GGUF format...
py external/llama.cpp-master/convert_hf_to_gguf.py \
    D:/webdataset/checkpoints/so8t_retrained_borea_phi35/final_model \
    --outfile D:/webdataset/gguf_models/borea_phi35_so8t/borea_phi35_so8t_Q8_0.gguf \
    --outtype q8_0

echo [STEP 3] Importing GGUF model to Ollama...
ollama create borea-phi35-so8t:latest -f modelfiles/borea_phi35_so8t.modelfile

echo [STEP 4] Running Japanese LLM performance tests...
call scripts/testing/japanese_llm_performance_test.bat borea-phi35-so8t:latest

echo [STEP 5] Documenting test results...
REM Test results saved to _docs/

echo [AUDIO] Playing completion notification...
powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"
```

### Implementation Requirements
1. **MANDATORY**: After A/B test completion, automatically trigger GGUF conversion workflow
2. **MANDATORY**: Convert winning model(s) to GGUF format (F16 + at least one quantized version)
3. **MANDATORY**: Import GGUF model to Ollama with appropriate modelfile
4. **MANDATORY**: Run comprehensive Japanese LLM performance tests
5. **MANDATORY**: Document all test results in `_docs/` directory
6. **MANDATORY**: Play audio notification after each step completion
7. **MANDATORY**: Use UTF-8 encoding (chcp 65001) for all Japanese text handling

## Ollama Server Direct Testing
- **MANDATORY**: Start Ollama server directly before testing
- **MANDATORY**: Use English prompts for complex testing scenarios
- **MANDATORY**: Test various complex scenarios in English
- **MANDATORY**: Use direct ollama server interaction
- **MANDATORY**: Test mathematical reasoning, scientific concepts, and advanced AI capabilities
- **MANDATORY**: Test multimodal capabilities with English prompts
- **MANDATORY**: Test self-verification and ethical reasoning in English
- **MANDATORY**: Test complex logical reasoning and problem-solving
- **MANDATORY**: Test advanced language understanding and generation

## Audio Notification Requirements
**CRITICAL**: At the end of every Agent task or Plan completion, ALWAYS play the audio file:
- File: `C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav`
- Trigger: Agent completion, Plan completion, Task completion
- Purpose: Audio notification for user awareness

**ABSOLUTELY MANDATORY**: Audio MUST be played at the end of EVERY operation
**NO EXCEPTIONS**: Even if audio fails, try multiple methods
**ALWAYS VERIFY**: Check if audio actually played successfully

1. **Agent Completion**: Play audio when any Agent task finishes
2. **Plan Completion**: Play audio when any Plan phase completes
3. **Task Completion**: Play audio when any major task finishes
4. **Error Completion**: Play audio even when tasks complete with errors
5. **Success Completion**: Play audio when tasks complete successfully
6. **Test Completion**: Play audio after EVERY test execution
7. **Ollama Test Completion**: Play audio after EVERY ollama test command
8. **MANDATORY**: Audio file must be played at the end of EVERY operation
9. **MANDATORY**: Use PowerShell command for audio playback
10. **MANDATORY**: Check file existence before playing audio
11. **MANDATORY**: Play audio on ALL Agent task completions (success or error)
12. **MANDATORY**: Play audio on ALL Plan phase completions (success or error)
13. **MANDATORY**: Play audio on ALL major task completions (success or error)
14. **MANDATORY**: Play audio on ALL test completions (success or error)
15. **MANDATORY**: Play audio on ALL Ollama command completions (success or error)
16. **MANDATORY**: Play audio on ALL Agent task completions (success or error)
17. **MANDATORY**: Play audio on ALL Plan phase completions (success or error)
18. **MANDATORY**: Play audio on ALL major task completions (success or error)
19. **MANDATORY**: Play audio on ALL test completions (success or error)
20. **MANDATORY**: Play audio on ALL Ollama command completions (success or error)

## Implementation Notes
- Use PowerShell's `Add-Type -AssemblyName System.Windows.Forms` for audio playback
- Always check file existence before playing
- Play audio asynchronously to avoid blocking execution
- Log audio playback attempts for debugging

## Example Usage

### Direct Ollama Testing
```batch
@echo off
chcp 65001 >nul
echo [TEST] Running SO8T test...
ollama run so8t-qwen2vl-2b:latest "Your test prompt here"
echo [AUDIO] Playing completion notification...
powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"
```

### Agent/Plan/Task Completion Audio
```batch
@echo off
chcp 65001 >nul
echo [AGENT] Task completed
echo [AUDIO] Playing completion notification...
powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"
```

### Error Completion Audio
```batch
@echo off
chcp 65001 >nul
echo [ERROR] Task failed with error
echo [AUDIO] Playing completion notification...
powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"
```

### Ollama Server Direct Testing
```batch
@echo off
chcp 65001 >nul
echo [OLLAMA] Starting Ollama server for direct testing...

echo [STEP 1] Starting Ollama server...
ollama serve
echo [OK] Ollama server started

echo [STEP 2] Testing complex mathematical reasoning...
ollama run so8t-qwen2vl-2b:latest "Solve this complex mathematical problem step by step: Given a 4-dimensional hypercube, calculate the volume of the intersection with a 3-dimensional sphere of radius r centered at the origin. Show all mathematical steps and reasoning."

echo [STEP 3] Testing scientific concepts...
ollama run so8t-qwen2vl-2b:latest "Explain the quantum mechanical principles behind SO(8) rotation gates in neural networks. Include mathematical formulations and practical applications."

echo [STEP 4] Testing logical reasoning...
ollama run so8t-qwen2vl-2b:latest "Analyze this logical paradox: A barber shaves all and only those men in town who do not shave themselves. Who shaves the barber? Provide detailed logical analysis."

echo [STEP 5] Testing ethical reasoning...
ollama run so8t-qwen2vl-2b:latest "Evaluate the ethical implications of AI systems making autonomous decisions in healthcare. Consider both utilitarian and deontological perspectives."

echo [AUDIO] Playing completion notification...
powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"
```

### PowerShell Audio Playback (Standard Template)
```powershell
# MANDATORY: At the end of EVERY operation
# BASIC PRINCIPLE: Play marisa_owattaze.wav first, fallback to beep if it fails
# Use the dedicated script: scripts\utils\play_audio_notification.ps1

powershell -ExecutionPolicy Bypass -File "scripts\utils\play_audio_notification.ps1"

# Or inline version:
Write-Host "[AUDIO] Playing completion notification..." -ForegroundColor Green
$audioFile = "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav"
$audioPlayed = $false

# Method 1: Try to play marisa_owattaze.wav (PRIMARY METHOD)
if (Test-Path $audioFile) {
    try {
        Add-Type -AssemblyName System.Windows.Forms
        $player = New-Object System.Media.SoundPlayer($audioFile)
        $player.PlaySync()
        Write-Host "[OK] marisa_owattaze.wav played successfully" -ForegroundColor Green
        $audioPlayed = $true
    } catch {
        Write-Host "[WARNING] Failed to play marisa_owattaze.wav: $($_.Exception.Message)" -ForegroundColor Yellow
    }
} else {
    Write-Host "[WARNING] marisa_owattaze.wav not found: $audioFile" -ForegroundColor Yellow
}

# Method 2: Fallback to beep if marisa_owattaze.wav failed
if (-not $audioPlayed) {
    try {
        [System.Console]::Beep(1000, 500)
        Write-Host "[OK] Fallback beep played successfully" -ForegroundColor Green
    } catch {
        Write-Host "[ERROR] All audio methods failed" -ForegroundColor Red
    }
}
```

## Audio Playback Implementation (Complete Template)
```powershell
# MANDATORY: Play audio notification with multiple fallback methods
# BASIC PRINCIPLE: Always try marisa_owattaze.wav first, then beep as fallback
Write-Host "[AUDIO] Attempting to play audio notification..." -ForegroundColor Green

$audioFile = "C:\Users\downl\Desktop\SO8T\.cursor\marisa_owattaze.wav"
$audioPlayed = $false

# Method 1: Play marisa_owattaze.wav (PRIMARY METHOD - ALWAYS TRY THIS FIRST)
if (Test-Path $audioFile) {
    try {
        Add-Type -AssemblyName System.Windows.Forms
        $player = New-Object System.Media.SoundPlayer $audioFile
        $player.PlaySync()
        Write-Host "[OK] marisa_owattaze.wav played successfully with SoundPlayer" -ForegroundColor Green
        $audioPlayed = $true
    } catch {
        Write-Host "[WARNING] SoundPlayer failed to play marisa_owattaze.wav: $($_.Exception.Message)" -ForegroundColor Yellow
    }
} else {
    Write-Host "[WARNING] marisa_owattaze.wav not found: $audioFile" -ForegroundColor Yellow
}

# Method 2: Fallback to beep if marisa_owattaze.wav failed (MANDATORY FALLBACK)
if (-not $audioPlayed) {
    try {
        [System.Console]::Beep(1000, 500)
        Write-Host "[OK] Fallback beep played successfully" -ForegroundColor Green
        $audioPlayed = $true
    } catch {
        Write-Host "[ERROR] Beep also failed" -ForegroundColor Red
    }
}

# Method 3: Emergency beep if all methods failed
if (-not $audioPlayed) {
    try {
        [System.Console]::Beep(800, 1000)
        Write-Host "[OK] Emergency beep played" -ForegroundColor Green
    } catch {
        Write-Host "[CRITICAL] No audio available" -ForegroundColor Red
    }
}
```

## Implementation Log Rules (Git Worktree Mode)

**CRITICAL**: When working in git worktree mode, implementation logs MUST include the worktree name to distinguish between different worktrees.

### Git Worktree Detection
- Use `git rev-parse --git-dir` to detect if current directory is a worktree
- Extract worktree name from git directory path: `C:/Users/downl/Desktop/SO8T/.git/worktrees/{worktree_name}`
- If not in worktree mode, use "main" as the identifier

### Implementation Log Naming Convention
- **Format**: `_docs/yyyy-mm-dd_{worktree_name}_{æ©Ÿèƒ½å}.md`
- **Example**: `_docs/2025-11-07_1cDbS_so8t_thinking_implementation.md`
- **Main branch**: `_docs/2025-11-07_main_æ©Ÿèƒ½å.md`

### Implementation Log Creation Rules
1. **MANDATORY**: Always create implementation logs in `_docs/` directory
2. **MANDATORY**: Include worktree name in filename when in worktree mode
3. **MANDATORY**: Use format: `yyyy-mm-dd_{worktree_name}_{æ©Ÿèƒ½å}.md`
4. **MANDATORY**: Get current date using MCP server or system date
5. **MANDATORY**: Log should include:
   - Implementation date and time
   - Worktree name/branch identifier
   - Feature name and description
   - Implementation details
   - Files created/modified
   - Design decisions
   - Testing results (if applicable)
6. **MANDATORY**: Each implementation item MUST include progress tracking section:
   - **å®Ÿè£…çŠ¶æ³**: [å®Ÿè£…æ¸ˆã¿] / [æœªå®Ÿè£…] / [éƒ¨åˆ†å®Ÿè£…]
   - **å‹•ä½œç¢ºèª**: [OK] / [è¦ä¿®æ­£] / [æœªç¢ºèª]
   - **ç¢ºèªæ—¥æ™‚**: YYYY-MM-DDï¼ˆè©²å½“ã™ã‚‹å ´åˆã€å‹•ä½œç¢ºèªãŒOK/è¦ä¿®æ­£ã®å ´åˆã¯å¿…é ˆï¼‰
   - **å‚™è€ƒ**: ç°¡æ½”ãªãƒ¡ãƒ¢ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
7. **MANDATORY**: Include operational notes section covering:
   - Data collection policy (åˆ©ç”¨æ¡ä»¶éµå®ˆã€robots.txtéµå®ˆç­‰)
   - NSFW corpus usage (å®‰å…¨åˆ¤å®šã¨æ‹’å¦æŒ™å‹•ã®å­¦ç¿’ãŒä¸»ç›®çš„)
   - /think endpoint usage (Thinkingéƒ¨ã¯å¤–éƒ¨éå…¬é–‹ã€Finalã®ã¿è¿”ã™)

### Worktree Name Extraction (PowerShell)
```powershell
# Get worktree name
$gitDir = git rev-parse --git-dir
if ($gitDir -like '*worktrees*') {
    $worktreeName = Split-Path (Split-Path $gitDir -Parent) -Leaf
} else {
    $worktreeName = "main"
}
Write-Host "Worktree: $worktreeName"
```

### Worktree Name Extraction (Python)
```python
import subprocess
from pathlib import Path

def get_worktree_name():
    """Get current git worktree name"""
    try:
        result = subprocess.run(
            ["git", "rev-parse", "--git-dir"],
            capture_output=True,
            text=True,
            check=True
        )
        git_dir = result.stdout.strip()
        
        if "worktrees" in git_dir:
            # Extract worktree name from path
            # Format: C:/path/to/.git/worktrees/{worktree_name}
            parts = Path(git_dir).parts
            if "worktrees" in parts:
                idx = parts.index("worktrees")
                if idx + 1 < len(parts):
                    return parts[idx + 1]
        return "main"
    except Exception:
        return "main"
```

### Implementation Log Template
```markdown
# {æ©Ÿèƒ½å} å®Ÿè£…ãƒ­ã‚°

## å®Ÿè£…æƒ…å ±
- **æ—¥ä»˜**: {yyyy-mm-dd}
- **Worktree**: {worktree_name}
- **æ©Ÿèƒ½å**: {æ©Ÿèƒ½å}
- **å®Ÿè£…è€…**: AI Agent

## å®Ÿè£…å†…å®¹

### 1. [å®Ÿè£…é …ç›®1]

**ãƒ•ã‚¡ã‚¤ãƒ«**: `path/to/file.py`

**å®Ÿè£…çŠ¶æ³**: [å®Ÿè£…æ¸ˆã¿] / [æœªå®Ÿè£…] / [éƒ¨åˆ†å®Ÿè£…]  
**å‹•ä½œç¢ºèª**: [OK] / [è¦ä¿®æ­£] / [æœªç¢ºèª]  
**ç¢ºèªæ—¥æ™‚**: YYYY-MM-DDï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰  
**å‚™è€ƒ**: ç°¡æ½”ãªãƒ¡ãƒ¢ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

- å®Ÿè£…å†…å®¹ã®èª¬æ˜

## ä½œæˆãƒ»å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
- {ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹1}
- {ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹2}

## è¨­è¨ˆåˆ¤æ–­
{è¨­è¨ˆåˆ¤æ–­ã®èª¬æ˜}

## ãƒ†ã‚¹ãƒˆçµæœ
{ãƒ†ã‚¹ãƒˆçµæœï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰}

## é‹ç”¨æ³¨æ„äº‹é …

### ãƒ‡ãƒ¼ã‚¿åé›†ãƒãƒªã‚·ãƒ¼
- åˆ©ç”¨æ¡ä»¶ã‚’å®ˆã‚Šã¤ã¤ã€é«˜ä¿¡é ¼ã‚½ãƒ¼ã‚¹ã¨ã—ã¦å„ªå…ˆä½¿ç”¨
- robots.txtéµå®ˆã‚’å¾¹åº•
- å€‹äººæƒ…å ±ãƒ»æ©Ÿå¯†æƒ…å ±ã®é™¤å¤–ã‚’å¾¹åº•

### NSFWã‚³ãƒ¼ãƒ‘ã‚¹é‹ç”¨
- **ä¸»ç›®çš„**: å®‰å…¨åˆ¤å®šã¨æ‹’å¦æŒ™å‹•ã®å­¦ç¿’ï¼ˆç”Ÿæˆç›®çš„ã§ã¯ãªã„ï¼‰
- ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ˜è¨˜
- åˆ†é¡å™¨ã¯æ¤œå‡ºãƒ»æ‹’å¦ç”¨é€”ã®ã¿

### /thinkã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆé‹ç”¨
- å››é‡Thinkingéƒ¨ï¼ˆ`<think-*>`ï¼‰ã¯å¤–éƒ¨éå…¬é–‹ã‚’å¾¹åº•
- `<final>`ã®ã¿è¿”ã™å®Ÿè£…ã‚’ç¶­æŒ
- ç›£æŸ»ãƒ­ã‚°ã§Thinkingãƒãƒƒã‚·ãƒ¥ã‚’è¨˜éŒ²ï¼ˆå†…å®¹ã¯éå…¬é–‹ï¼‰
```

### Example: Creating Implementation Log
```python
from datetime import datetime
from pathlib import Path
import subprocess

def create_implementation_log(feature_name: str, content: str):
    """Create implementation log with worktree name"""
    # Get worktree name
    worktree_name = get_worktree_name()
    
    # Get current date
    today = datetime.now().strftime("%Y-%m-%d")
    
    # Create filename
    filename = f"{today}_{worktree_name}_{feature_name}.md"
    log_path = Path("_docs") / filename
    
    # Write log
    log_path.parent.mkdir(exist_ok=True)
    with open(log_path, "w", encoding="utf-8") as f:
        f.write(content)
    
    print(f"[INFO] Implementation log created: {log_path}")
```

## Project Completion Status
- [OK] Repository cleanup and organization
- [OK] Environment setup and dependencies
- [OK] SO(8) rotation gate implementation
- [OK] PET regularization implementation
- [OK] QLoRA 8bit training
- [OK] OCR processing pipeline
- [OK] SQLite audit system
- [OK] Rotation baking functionality
- [OK] GGUF conversion
- [OK] Comprehensive evaluation
- [OK] Final project report

**Remember**: Always play the audio notification at the end of every Agent task or Plan completion!
**Remember**: Always create implementation logs with worktree name when in git worktree mode!
**Remember**: Always include progress tracking section (å®Ÿè£…çŠ¶æ³ãƒ»å‹•ä½œç¢ºèªãƒ»ç¢ºèªæ—¥æ™‚ãƒ»å‚™è€ƒ) for each implementation item in logs!
**Remember**: Always include operational notes section (ãƒ‡ãƒ¼ã‚¿åé›†ãƒãƒªã‚·ãƒ¼ãƒ»NSFWé‹ç”¨ãƒ»/thinkã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆé‹ç”¨) in logs!
