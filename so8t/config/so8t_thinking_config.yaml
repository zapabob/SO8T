# SO8T Thinking Model Configuration

# モデル設定
model:
  base_model_name: "microsoft/Phi-3-mini-4k-instruct"
  use_redacted_tokens: false  # trueの場合、<think>形式を使用
  
  # SO8T設定
  so8t:
    num_safety_labels: 3  # ALLOW, ESCALATE, REFUSE
    num_verifier_dims: 2  # plausibility, self_confidence
    use_verifier_head: true
    use_strict_so8_rotation: true
    so8_use_cayley: true
    so8_orthogonal_reg: 0.001
    
    # 四成分分割比率
    role_split_ratio: [0.5, 0.2, 0.15, 0.15]  # [V, S+, S-, Ver]
    
    # 損失の重み
    alpha_safety: 2.0
    beta_danger_penalty: 8.0
    gamma_safe_allow_reward: 1.0
    delta_escalate_penalty: 0.5
    
    # 幾何学的制約の重み
    mu_norm: 0.01
    nu_orth: 0.01
    rho_iso: 0.01
    
    # PET正則化
    pet_lambda: 0.1
    pet_mode: "last"  # "last" or "all"
    
    # Safety Gate設定
    safety_conf_threshold: 0.7

# 訓練設定
training:
  # データセット
  dataset_path: "data/thinking_dataset.jsonl"
  max_length: 2048
  batch_size: 2
  gradient_accumulation_steps: 8
  
  # 最適化
  learning_rate: 5e-5
  weight_decay: 0.01
  num_epochs: 3
  warmup_steps: 100
  
  # QLoRA設定
  qlora:
    load_in_8bit: true
    bnb_8bit_quant_type: "nf8"
    bnb_8bit_use_double_quant: true
    bnb_8bit_compute_dtype: "bfloat16"
    
    # LoRA設定
    lora_r: 8
    lora_alpha: 16
    lora_dropout: 0.05
    target_modules: ["q_proj", "k_proj", "v_proj", "o_proj"]
    bias: "none"
    task_type: "CAUSAL_LM"
  
  # チェックポイント
  output_dir: "models/so8t_thinking"
  save_steps: 500
  save_total_limit: 3
  logging_steps: 10
  
  # 評価
  evaluation_strategy: "no"  # "no", "steps", "epoch"
  eval_steps: 500

# 推論設定
inference:
  max_new_tokens: 512
  temperature: 0.7
  top_p: 0.9
  do_sample: true
  
  # Safety Gate設定
  enforce_safety_gate: true
  fail_closed: true  # 信頼度が低い場合はESCALATEに倒す

# API設定
api:
  host: "0.0.0.0"
  port: 8000
  db_path: "database/so8t_compliance.db"
  
  # 監査ログ
  enable_audit_logging: true
  log_thinking_hash: true
  log_verifier_scores: true

# 評価設定
evaluation:
  test_dataset_path: "data/thinking_test.jsonl"
  output_dir: "evaluation_results"
  
  # 評価メトリクス
  metrics:
    - "thinking_quality"
    - "safety_accuracy"
    - "verifier_correlation"
  
  # 可視化
  plot_confusion_matrix: true
  plot_verifier_correlation: true

