# SO8T完全自動化マスターパイプライン設定ファイル
# 電源投入時・再起動時に自動実行される統合パイプライン

# パイプライン全体設定
pipeline:
  name: "SO8T完全自動化マスターパイプライン"
  output_base_dir: "D:/webdataset"
  checkpoint_dir: "D:/webdataset/checkpoints/master_pipeline"
  resume: true  # チェックポイントから再開可能
  session_id_format: "%Y%m%d_%H%M%S"

# 依存関係自動チェック・インストール設定
dependencies:
  enabled: true
  auto_install: true
  check_before_start: true
  required_packages:
    - mlflow>=2.8.0
    - wandb>=0.15.0
    - tensorboard>=2.13.0
    - psutil>=5.9.0
    - numpy>=1.24.0
    - pandas>=2.0.0
    - scikit-learn>=1.3.0
    - tqdm>=4.65.0
    - pyyaml>=6.0
    - torch>=2.0.0
    - transformers>=4.35.0
    - peft>=0.6.0
    - bitsandbytes>=0.41.0
    - accelerate>=0.24.0
    - matplotlib>=3.7.0
    - seaborn>=0.12.0
    - plotly>=5.15.0
    - joblib>=1.3.0

# Phase 0: 依存関係チェック
phase0_dependencies:
  enabled: true
  script: "scripts/utils/auto_install_dependencies.py"
  continue_on_failure: false  # 依存関係エラー時は停止

# Phase 1: Webスクレイピングとデータ収集
phase1_web_scraping:
  enabled: true
  use_playwright: true  # Playwrightクローラーを使用
  use_cursor_browser: true  # Cursorのブラウザに接続
  remote_debugging_port: 9222  # Cursorブラウザのリモートデバッグポート
  use_existing_pipeline: false  # Playwright使用時は既存パイプラインを使用しない
  pipeline_config: "configs/data_pipeline_config.yaml"
  script: "scripts/pipelines/complete_data_pipeline.py"
  output_dir: "D:/webdataset/processed/four_class"
  target_samples: 100000
  delay: 1.0  # リクエスト間の遅延（秒）
  timeout: 30000  # ページロードタイムアウト（ミリ秒）
  required: true  # 必須フェーズ

# Phase 2: データクレンジングと前処理
phase2_data_cleansing:
  enabled: true
  use_existing_pipeline: true
  output_dir: "D:/webdataset/processed/finetuning"
  required: true  # 必須フェーズ

# Phase 3: modeling_phi3.pyのSO8T統合
phase3_modeling_so8t:
  enabled: true
  modeling_file: "models/Borea-Phi-3.5-mini-Instruct-Jp/modeling_phi3_so8t.py"
  verify_existence: true
  required: true  # 必須フェーズ

# Phase 4: SO8T統合スクリプト
phase4_integration:
  enabled: true
  script: "scripts/conversion/integrate_phi3_so8t.py"
  model_path: "models/Borea-Phi-3.5-mini-Instruct-Jp"
  output_path: "D:/webdataset/models/so8t_integrated/phi3_so8t"
  device: "cuda"
  verify: true
  torch_dtype: "bfloat16"
  required: true  # 必須フェーズ

# Phase 5: QLoRA 8bitファインチューニング
phase5_qlora_training:
  enabled: true
  script: "scripts/training/train_so8t_phi3_qlora.py"
  config: "configs/train_so8t_phi3_qlora.yaml"
  resume: true  # チェックポイントから再開可能
  output_dir: "D:/webdataset/checkpoints/finetuning/so8t_phi3"
  required: true  # 必須フェーズ

# Phase 6: モデル評価
phase6_evaluation:
  enabled: true
  script: "scripts/evaluation/evaluate_so8t_phi3.py"
  eval_dataset: "D:/webdataset/processed/finetuning/eval.jsonl"
  output_dir: "D:/webdataset/evaluation_results"
  required: false  # オプションフェーズ

# Phase 7: A/Bテスト実行
phase7_ab_test:
  enabled: true
  script: "scripts/evaluation/ab_test_borea_phi35_original_vs_so8t.py"
  base_model: "models/Borea-Phi-3.5-mini-Instruct-Jp"
  retrained_model: "D:/webdataset/checkpoints/finetuning/so8t_phi3"
  test_data: "D:/webdataset/processed/finetuning/eval.jsonl"
  output_dir: "D:/webdataset/ab_test_results"
  required: false  # オプションフェーズ

# Phase 8: A/Bテスト後処理（勝者判定・GGUF変換・Ollamaインポート）
phase8_post_processing:
  enabled: true
  script: "scripts/pipelines/complete_ab_test_post_processing_pipeline.py"
  config: "configs/complete_ab_test_post_processing_config.yaml"
  gguf_output_dir: "D:/webdataset/gguf_models"
  convert_script: "external/llama.cpp-master/convert_hf_to_gguf.py"
  quantizations: ["f16", "q8_0"]
  ollama_model_name: "so8t-phi3"
  modelfile_dir: "modelfiles"
  required: false  # オプションフェーズ

# Phase 9: 日本語パフォーマンステスト
phase9_japanese_test:
  enabled: true
  script: "scripts/testing/japanese_llm_performance_test.py"
  output_dir: "_docs"
  required: false  # オプションフェーズ

# 各フェーズの依存関係
dependencies_phases:
  phase2_data_cleansing:
    - phase1_web_scraping
  phase4_integration:
    - phase3_modeling_so8t
  phase5_qlora_training:
    - phase4_integration
    - phase2_data_cleansing
  phase6_evaluation:
    - phase5_qlora_training
  phase7_ab_test:
    - phase5_qlora_training
  phase8_post_processing:
    - phase7_ab_test
  phase9_japanese_test:
    - phase8_post_processing

# エラーハンドリング設定
error_handling:
  max_retries: 3  # 各フェーズで最大3回リトライ
  retry_delay: 60  # リトライ間隔（秒）
  continue_on_error: false  # 必須フェーズエラー時は停止
  continue_on_optional_error: true  # オプションフェーズエラー時は警告のみ
  save_error_log: true
  error_log_dir: "D:/webdataset/pipeline_logs/errors"

# チェックポイント設定
checkpoint:
  enabled: true
  interval_seconds: 300  # 5分間隔で自動保存
  max_checkpoints: 10  # 最大10個のチェックポイントを保持
  save_dir: "D:/webdataset/checkpoints/master_pipeline"
  auto_recovery: true  # 電源断からの自動復旧
  recovery_timeout: 86400  # 24時間以内のチェックポイントのみ復旧

# 進捗管理設定
progress:
  enabled: true
  log_interval: 1800  # 30分間隔で進捗ログ生成
  log_dir: "_docs/progress_logs"
  format: "markdown"  # markdown形式でログ生成
  include_metrics: true
  include_timestamps: true

# リソースバランス設定
resource_balance:
  enabled: true
  gpu_threshold: 0.9
  memory_threshold: 0.9
  cpu_threshold: 0.8
  auto_adjust: true
  monitor_interval: 60  # 60秒間隔で監視

# ログ設定
logging:
  level: "INFO"
  log_file: "D:/webdataset/pipeline_logs/master_automated_pipeline.log"
  log_interval: 300  # 5分間隔でログ
  max_log_size_mb: 100  # 最大ログサイズ（MB）
  log_rotation: true

# 通知設定
notifications:
  audio_notification: true
  audio_file: "C:/Users/downl/Desktop/SO8T/.cursor/marisa_owattaze.wav"
  play_on_completion: true
  play_on_error: true
  play_on_phase_completion: true  # 各フェーズ完了時にも再生
  fallback_beep: true  # 音声ファイル失敗時のフォールバック

# Windowsタスクスケジューラ設定
task_scheduler:
  enabled: true
  task_name: "SO8T-MasterAutomatedPipeline-AutoStart"
  trigger: "onstart"  # システム起動時
  user: "SYSTEM"  # SYSTEMアカウントで実行
  priority: "highest"  # 最高権限
  delay_seconds: 30  # システム起動後30秒待機
  script_path: "scripts/pipelines/master_automated_pipeline.py"
  python_executable: "auto"  # 自動検出

# データソース設定（Phase 1用）
data_sources:
  enable_specialized_crawlers: true
  enable_parallel_crawler: true
  max_pages_per_source: 1000
  
  # 4web版官報
  enable_kanpou_4web: true
  
  # e-Gov
  enable_egov: true
  
  # zenn
  enable_zenn: true
  zenn_api_enabled: false
  
  # Qiita
  enable_qiita: true
  qiita_api_enabled: false
  qiita_api_token: null
  
  # ウィキペディア日本語版
  enable_wikipedia_ja: true
  
  # 日経225企業（並列クローラー経由）
  enable_nikkei225: true

# Ollama設定
ollama:
  base_url: "http://localhost:11434"
  model_a_name: "borea-phi35-mini-q8_0"
  model_b_name: "so8t-borea-phi35-mini-q8_0"
  check_before_import: true  # インポート前にOllama起動確認

# ベンチマーク設定（Phase 6用）
benchmarks:
  hf_benchmark:
    enabled: true
    tasks: ["glue", "superglue", "japanese"]
  llm_benchmark:
    enabled: true
    test_suite: "scripts/evaluation/llm_benchmark_suite.json"

