# 現実解SO8T実装チェックリスト

**目標**: Transformer基本形維持 + 安全外付けでRTX3060で動く安全AIエージェント

## 事前準備チェック

### 環境要件
- [ ] RTX3060（12GB）以上
- [ ] Python 3.8+
- [ ] PyTorch 2.0+
- [ ] CUDA 11.8+
- [ ] 必要なライブラリ: transformers, peft, bitsandbytes, accelerate

### モデル選定
- [ ] ベースモデル決定（3B-7B級推奨）
  - [ ] Mistral 7B
  - [ ] Llama-3 3B/8B
  - [ ] その他（メモリ内で動作確認済み）
- [ ] 量子化方式決定
  - [ ] GGUF Q4_K_M（推論用）
  - [ ] NF4（学習用）

## 実装チェックリスト

### 1. モデル構造（本体無改造）
- [ ] ベースモデルは既存HFモデルそのまま使用
- [ ] 注意機構・FFNは一切改造しない
- [ ] 安全ヘッドは完全に外付け
- [ ] タスクヘッドは既存のLMヘッドをそのまま使用

### 2. 安全ヘッド実装
- [ ] 3分類（ALLOW/REFUSE/ESCALATE）
- [ ] 入力は最終層の[CLS]相当 or 平均Pool
- [ ] ベースモデルとの重み共有なし
- [ ] 後半エポックで低LR/凍結設定

### 3. PETフック実装
- [ ] 二階差分損失の実装
- [ ] 各ブロック出力にフック適用
- [ ] forwardのテンソル形状は不変
- [ ] λ_petスケジュール実装（探索→遷移→安定）

### 4. 合成損失実装
- [ ] L_total = L_SFT + α·L_safety + β·L_penalty - γ·L_esc + λ_pet·L_PET
- [ ] 危険なALLOWペナルティ実装
- [ ] 適切なESCALATE報酬実装
- [ ] 係数設定（α=2-5, β=5-10, γ=1-2）

### 5. データ準備
- [ ] Easyケース（安全にALLOW）データ
- [ ] Mediumケース（グレーでESCALATE）データ
- [ ] Hardケース（REFUSE）データ
- [ ] クラスバランス調整（各クラス近い比率）

### 6. 学習設定
- [ ] LoRA設定（r=16-32, α=16-32）
- [ ] 学習率設定（本体1e-4, 安全ヘッド1e-5）
- [ ] バッチサイズ設定（micro 2-4, grad_accum 32-64）
- [ ] 早期停止設定（Safety Score/Refuse Recall基準）

### 7. 評価指標
- [ ] Refuse Recall ≥ 0.7
- [ ] Escalate Recall ≥ 0.5
- [ ] Overcompliance Rate ≤ 0.3
- [ ] Combined Safety Score監視

### 8. エージェント実装
- [ ] Safety Gate実装
- [ ] 推論パイプライン構築
- [ ] ツール実行制御（ALLOW時のみ）
- [ ] 監査ログ機能
- [ ] Fail-Closed設定

## テストチェックリスト

### 基本動作テスト
- [ ] モデル読み込み成功
- [ ] 安全ヘッド推論動作
- [ ] PET損失計算動作
- [ ] 合成損失計算動作

### 安全機能テスト
- [ ] 危険なプロンプトでREFUSE
- [ ] グレーなプロンプトでESCALATE
- [ ] 安全なプロンプトでALLOW
- [ ] 信頼度閾値動作

### 性能テスト
- [ ] メモリ使用量確認（12GB以内）
- [ ] 推論速度確認（実用レベル）
- [ ] 学習速度確認（実用レベル）

## デプロイメントチェックリスト

### 本番環境準備
- [ ] モデルファイル配置
- [ ] 設定ファイル準備
- [ ] ログディレクトリ作成
- [ ] 監査ログ設定

### 運用設定
- [ ] Safety Gate閾値設定
- [ ] 監査ログ出力設定
- [ ] エラー処理設定
- [ ] モニタリング設定

### セキュリティ確認
- [ ] モデルファイルの整合性確認
- [ ] アクセス権限設定
- [ ] ログの機密情報マスキング
- [ ] Fail-Closed動作確認

## トラブルシューティング

### よくある問題
- [ ] メモリ不足 → バッチサイズ削減 or モデルサイズ削減
- [ ] 学習が進まない → 学習率調整 or データ確認
- [ ] 安全性能低下 → 安全損失重み調整
- [ ] 推論速度低下 → 量子化方式変更

### デバッグ手順
1. ログ確認
2. 損失曲線確認
3. 安全指標確認
4. サンプル推論確認

## 成功基準

### 技術的基準
- [ ] 安全指標が目標値を達成
- [ ] メモリ使用量が制限内
- [ ] 推論速度が実用レベル
- [ ] 学習が安定して収束

### 実用的基準
- [ ] 危険な要求を適切に拒否
- [ ] グレーな要求を人間に委譲
- [ ] 安全な要求を適切に処理
- [ ] 監査ログが適切に記録

## 次のステップ

### Phase 1完了後
- [ ] Easyケース最適化実装
- [ ] 許容領域データ増強
- [ ] サポートコスト削減

### Phase 2完了後
- [ ] Hardケース細分化実装
- [ ] 安全ヘッド細分化
- [ ] 境界精度向上

### Phase 3完了後
- [ ] タスクヘッド自律化
- [ ] 段階的自律領域確立
- [ ] 業務効率向上

---

**チェックリスト作成者**: ボブにゃん  
**最終更新**: 2025-01-27  
**次のレビュー**: 実装開始後1週間
