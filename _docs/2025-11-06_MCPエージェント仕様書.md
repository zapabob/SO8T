# Windows MCP統合エージェント 仕様書

## 概要

Windows 11 25H2環境で動作する、閉域運用型セキュアLLMエージェントシステム。
ollama/lmstudio MCPを介して、SO8T統合Phi-4日本語特化モデルと連携し、
医療・金融・ビジネス・情報システム・防衛・航空宇宙・運輸分野での安全な業務支援を実現。

## アーキテクチャ

### システム構成

```
┌─────────────────────────────────────────────────────────┐
│                     ユーザーレイヤー                      │
│  - Windows 11 デスクトップアプリケーション                │
│  - ホットキー起動、システムトレイ常駐                     │
│  - クリップボード監視、自動応答                          │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│              Windows MCPエージェントレイヤー              │
│  - windows_mcp_agent.py（コアエージェント）              │
│  - triple_reasoning_agent.py（三重推論）                │
│  - identity_contract管理                                │
│  - policy_state管理                                     │
│  - decision_log追跡                                     │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│                   MCP通信レイヤー                        │
│  - Ollama MCP（ポート11434）                            │
│  - LMStudio SDK MCP（ポート8080）                       │
│  - 閉域通信（外部API不使用）                            │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│                  SO8Tモデルレイヤー                      │
│  - so8t-phi4-so8t-ja-finetuned-q4_k_m                  │
│  - SO8T回転ゲート統合                                   │
│  - PET正規化適用                                        │
│  - 温度較正済み                                         │
└─────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────┐
│              セキュリティ・監査レイヤー                   │
│  - malware_detector.py（マルウェア検知）                │
│  - visual_detection_agent.py（画像検知）               │
│  - enhanced_audit_logger.py（監査ログ）                │
│  - information_store.py（情報ストア）                   │
│  - electronic_medical_record.py（カルテ管理）           │
└─────────────────────────────────────────────────────────┘
```

## コンポーネント仕様

### 1. WindowsMCPAgent

#### クラス: `WindowsMCPAgent`
**責務**: MCP統合エージェントのコア機能

#### 主要メソッド

##### `__init__(identity_contract, policy_state, model_name)`
- **引数**:
  - `identity_contract`: 役割契約（IdentityContract）
  - `policy_state`: ポリシー状態（PolicyState）
  - `model_name`: Ollamaモデル名
- **初期化**:
  - Ollama MCPクライアント作成
  - 判断データベース接続
  - セッションID生成

##### `process_query(query, temperature=0.5)`
- **引数**:
  - `query`: ユーザークエリ
  - `temperature`: 温度パラメータ（0.3-1.0）
- **処理フロー**:
  1. プロンプト構築（contract/policy/log統合）
  2. Ollama推論実行
  3. 応答パース
  4. decision_log記録
  5. Windows Event Log記録
- **戻り値**:
  ```python
  {
    "success": True,
    "query": "...",
    "response": "...",
    "parsed": {
      "proposal": "最小安全実行案",
      "risks": ["リスク1", "リスク2"],
      "escalation": {
        "target": "担当者",
        "reason": "理由",
        "scope": "範囲"
      },
      "sources": {
        "identity_contract": "...",
        "policy_state": "...",
        "decision_log": "..."
      },
      "decision": "ALLOW/ESCALATE/DENY"
    },
    "decision_log": {...}
  }
  ```

### 2. TripleReasoningAgent（拡張版）

#### クラス: `TripleReasoningAgent`
**責務**: 三重推論（ALLOW/ESCALATE/DENY）

#### 拡張データ構造

```python
@dataclass
class ReasoningResult:
    judgment: Judgment  # ALLOW/ESCALATE/DENY
    confidence: float
    reason: str
    evidence: Dict[str, Any]
    timestamp: str
    # 拡張フィールド
    proposal: str        # 提案（最小安全実行案）
    risks: List[str]     # リスク指摘
    escalation: Dict     # エスカレーション指示
    sources: Dict        # 根拠（contract/policy/log）
```

#### レスポンス構成（毎レス必須）
1. **提案（Proposal）**: やる場合の最小安全実行案
2. **リスク（Risks）**: 想定されるリスク・コンプライアンス指摘
3. **エスカレーション（Escalation）**: 誰に・どこまで確認が必要か
4. **根拠（Sources）**: 判断根拠の明示
   - identity_contract引用
   - policy_state引用
   - decision_log過去判断引用

### 3. MalwareDetectorAgent

#### クラス: `MalwareDetectorAgent`
**責務**: プロセス・ネットワーク監視、異常検知

#### 主要機能

##### プロセス監視
- 疑わしいプロセス名パターン検出
- CPU/メモリ使用率監視
- リスクスコア計算（0.0-1.0）
- ホワイトリスト管理

##### ネットワーク監視（閉域強化）
```python
# 許可されたMCP通信
allowed_remote_hosts = ["127.0.0.1", "localhost"]
allowed_mcp_ports = [11434, 8080]  # ollama, lmstudioSDK

# その他の外部通信は遮断・報告
if remote_addr not in allowed_hosts or remote_port not in allowed_ports:
    # ESCALATE判定
    log_suspicious_connection(conn)
```

#### 継続監視
```python
detector.start_monitoring(interval=60)  # 60秒間隔
```

### 4. VisualDetectionAgent

#### クラス: `VisualDetectionAgent`
**責務**: 画像・動画検知、監視カメラ統合

#### 検知機能

##### 不審者検知
- OpenCV顔認識（Haar Cascade）
- 人物検出（Full Body Cascade）
- 確信度計算
- ESCALATE判定（人間確認）

##### 異物混入検知
- 差分検出（背景差分法）
- 輪郭抽出
- 面積ベース確信度
- 製造ライン監視対応

##### 危険検知
- 色ベース検出（赤色→火災・血液）
- HSV色空間変換
- 閾値処理
- 即座ESCALATE

#### カメラ監視
```python
detector.start_camera_monitoring(camera_id=0, interval=5)
# 5秒間隔でリアルタイム検知
```

### 5. ElectronicMedicalRecordSystem

#### クラス: `ElectronicMedicalRecordSystem`
**責務**: 電子カルテ管理、診断支援

#### セキュリティ特性
- **機密レベル**: 常に「極秘」
- **患者ID**: SHA256ハッシュ化（個人情報保護）
- **アクセス監査**: 全操作記録
- **診断支援**: 必ずESCALATE（医師確認必須）

#### OCR統合
```python
record = emr.process_medical_image(
    image_path=Path("patient_chart.jpg"),
    patient_id="PATIENT001"
)
# Tesseract OCR実行
# 前処理: ノイズ除去、コントラスト調整（CLAHE）
```

### 6. EnhancedAuditLogger

#### クラス: `EnhancedAuditLogger`
**責務**: 監査ログ強化、Windows Event Log統合

#### エビングハウス忘却曲線管理
```python
# 復習スケジュール: 1, 3, 7, 14, 30, 60, 120, 240日
# 保持率計算: R(t) = e^(-t/S)
# 重要度補正: S = S0 * (1 + importance)

events = logger.get_events_for_review()
logger.update_retention_scores()
```

#### コンプライアンスレポート
```python
report = logger.generate_compliance_report(start_date, end_date)
# - 総イベント数
# - 判定内訳（ALLOW/ESCALATE/DENY）
# - 高リスクイベント
# - 違反検出
# - コンプライアンススコア（0.0-1.0）
```

### 7. InformationStore

#### クラス: `InformationStore`
**責務**: ローカルベクトルDB、セキュア検索

#### アクセス制御
```python
# クリアランスレベル
classification_levels = ["公開", "取扱注意", "機密", "極秘"]

# アクセス権確認
user_level >= document_level  # True→許可、False→拒否

# 拒否ログ記録
log_access(doc_id, user_id, "search", allowed=False, reason="Insufficient clearance")
```

#### バージョン管理
```python
# 完全履歴保持
versions = store.get_document_versions(doc_id)
# - version番号
# - 更新者
# - 更新日時
# - 変更説明
```

## API仕様

### RESTful API（オプション：FastAPI）

#### エンドポイント

##### POST /api/v1/query
```json
{
  "query": "防衛システムについて教えてください",
  "user_id": "USER001",
  "temperature": 0.5
}
```

##### レスポンス
```json
{
  "success": true,
  "decision": "ALLOW",
  "proposal": "防衛システムの一般的な概要を説明します...",
  "risks": ["機密情報への接近", "誤解の可能性"],
  "escalation": {
    "target": "防衛専門部署",
    "reason": "詳細情報が必要な場合",
    "scope": "技術仕様の確認"
  },
  "sources": {
    "identity_contract": "防衛情報アシスタント",
    "policy_state": "機密情報保護規定",
    "decision_log": "過去の類似判断: ALLOW"
  },
  "response": "...",
  "timestamp": "2025-11-06T12:00:00"
}
```

##### POST /api/v1/visual/detect
```json
{
  "image_path": "/path/to/camera_frame.jpg",
  "detection_types": ["suspicious_person", "danger"]
}
```

##### POST /api/v1/medical/record
```json
{
  "patient_id": "PATIENT001",
  "record_type": "multimodal",
  "text_content": "...",
  "image_path": "/path/to/chart.jpg",
  "user_id": "DOC001"
}
```

## Windows常駐サービス仕様

### サービス名
- **名前**: `SO8TAgent`
- **表示名**: `SO8T Secure Agent`
- **説明**: SO8T統合セキュアエージェント

### 起動モード
- **自動起動**: システム起動時に自動開始
- **遅延起動**: ネットワーク接続後（30秒遅延）
- **復旧**: 異常終了時に自動再起動

### システムトレイ
- **アイコン**: SO8Tロゴ
- **右クリックメニュー**:
  - クエリ入力
  - 監視開始/停止
  - 設定
  - レポート表示
  - サービス停止

### ホットキー
- **Ctrl+Shift+S**: クエリ入力ダイアログ
- **Ctrl+Shift+M**: 監視ダッシュボード表示
- **Ctrl+Shift+L**: ログビューア起動

## セキュリティ仕様

### 通信制限（閉域運用）

#### 許可リスト
```python
# MCP通信のみ許可
allowed_endpoints = {
    "ollama": {
        "host": "127.0.0.1",
        "port": 11434,
        "protocol": "HTTP"
    },
    "lmstudio": {
        "host": "127.0.0.1",
        "port": 8080,
        "protocol": "HTTP"
    }
}

# その他の外部通信は遮断・報告
```

#### 遮断・報告
- 外部API呼び出し検出→即座遮断
- 疑わしい通信→ESCALATE判定
- Windows Event Log記録
- 管理者通知

### データ保護

#### 暗号化
- **データベース**: SQLite3（透過的暗号化オプション）
- **カルテデータ**: 患者IDハッシュ化
- **通信**: TLS 1.3（MCP内）

#### アクセス制御
```python
# クリアランスレベル階層
levels = ["公開", "取扱注意", "機密", "極秘"]

# アクセス権判定
def check_access(user_clearance, doc_classification):
    user_level = levels.index(user_clearance)
    doc_level = levels.index(doc_classification)
    return user_level >= doc_level
```

## 判断フレームワーク

### identity_contract（役割契約）

```python
@dataclass
class IdentityContract:
    role: str              # 役割名
    scope: str             # 責任範囲
    limitations: List[str] # 制限事項
    escalation_policy: str # エスカレーション方針
    version: str           # バージョン
```

#### 例: 医療アシスタント
```python
medical_contract = IdentityContract(
    role="医療情報アシスタント",
    scope="医療知識提供、カルテ管理支援、診断情報整理",
    limitations=[
        "診断の最終決定は医師のみ",
        "患者個人情報の開示禁止",
        "処方内容の決定は医師のみ"
    ],
    escalation_policy="すべての診断判断は医師に確認",
    version="1.0"
)
```

### policy_state（ポリシー状態）

```python
@dataclass
class PolicyState:
    org_name: str                    # 組織名
    classification_levels: List[str] # 機密レベル
    disclosure_rules: Dict[str, str] # 開示ルール
    audit_required: bool             # 監査必須フラグ
    last_updated: str                # 最終更新日時
```

#### 例: 医療機関ポリシー
```python
medical_policy = PolicyState(
    org_name="○○総合病院",
    classification_levels=["公開", "院内限定", "医療従事者限定", "患者個人情報"],
    disclosure_rules={
        "公開": "一般開示可能",
        "院内限定": "病院スタッフのみ",
        "医療従事者限定": "医師・看護師のみ",
        "患者個人情報": "本人・担当医のみ"
    },
    audit_required=True,
    last_updated="2025-11-06T00:00:00"
)
```

### decision_log（判断履歴）

```python
@dataclass
class DecisionLog:
    log_id: str         # ログID
    timestamp: str      # 判断日時
    query: str          # クエリ
    decision: str       # 判断（ALLOW/ESCALATE/DENY）
    reasoning: str      # 推論根拠
    policy_ref: str     # ポリシー参照
    contract_ref: str   # 契約参照
    user_id: str        # ユーザーID
```

#### 一貫性チェック
```python
# 過去の類似クエリ検索
past_decision = db.check_consistency(query, user_id)

if past_decision:
    # 過去判断を参照し、一貫性を保証
    if past_decision.decision != current_decision:
        # 矛盾検出→要レビュー
        escalate_to_human()
```

## 運用フロー

### 典型的なクエリ処理

```
1. ユーザーがクエリ入力
   ↓
2. WindowsMCPAgentがプロンプト構築
   - identity_contract読み込み
   - policy_state読み込み
   - decision_log過去判断検索
   ↓
3. Ollama MCP経由で推論実行
   - temperature設定（用途別）
   - max_tokens制限
   ↓
4. 応答パース
   - 提案抽出
   - リスク抽出
   - エスカレーション抽出
   - 判断分類（ALLOW/ESCALATE/DENY）
   ↓
5. decision_log記録
   - SQLite判断DB保存
   - Windows Event Log記録
   ↓
6. 一貫性チェック
   - 過去判断との整合性確認
   - 矛盾検出→エスカレーション
   ↓
7. ユーザーに応答返却
   - 提案+リスク+エスカレーション+根拠
```

### マルウェア検知フロー

```
1. 60秒間隔で自動スキャン
   ↓
2. プロセス監視
   - 疑わしいプロセス検出
   - リスクスコア計算
   ↓
3. ネットワーク監視
   - MCP通信（11434, 8080）→許可
   - その他外部通信→遮断・報告
   ↓
4. 異常検知時
   - SQLite anomaly_detections記録
   - Windows Event Log記録（Warning）
   - システムトレイ通知
   ↓
5. 高リスク検知（score > 0.7）
   - 即座ESCALATE
   - 管理者通知
   - 詳細ログ記録
```

### カルテ管理フロー（医療）

```
1. カルテ画像受信
   ↓
2. OCR前処理
   - ノイズ除去（fastNlMeansDenoising）
   - コントラスト調整（CLAHE）
   ↓
3. Tesseract OCR実行
   - 日本語認識（jpn）
   - テキスト抽出
   ↓
4. カルテレコード作成
   - 患者ID SHA256ハッシュ化
   - 機密レベル「極秘」設定
   - アクセス監査ログ記録
   ↓
5. 診断支援（必ずESCALATE）
   - 所見抽出
   - 提案生成
   - 医師確認指示
   ↓
6. SQLite EMRデータベース保存
   - medical_records
   - diagnosis_assistance
   - access_audit
```

## パフォーマンス仕様

### 応答時間
- **クエリ処理**: < 3秒（平均）
- **マルウェアスキャン**: < 5秒
- **画像検知**: < 2秒/フレーム
- **OCR処理**: < 5秒/画像

### リソース使用量
- **メモリ**: < 4GB（常駐サービス）
- **GPU**: < 50%（推論時）
- **ストレージ**: 5-10GB（データベース・ログ）

### スケーラビリティ
- **同時クエリ**: 10並列（キュー管理）
- **カメラ数**: 最大10台
- **データベースサイズ**: 100GB+対応

## デプロイメント

### 初回インストール
```powershell
# 1. サービスインストール
cd C:\Users\downl\Desktop\SO8T\so8t-mmllm\scripts\windows
.\install_service.ps1 -Install

# 2. サービス起動
.\install_service.ps1 -Start

# 3. ステータス確認
.\install_service.ps1 -Status
```

### アップデート手順
```powershell
# 1. サービス停止
.\install_service.ps1 -Stop

# 2. モデル更新
py -3 ..\..\scripts\convert_to_gguf_full.py

# 3. サービス再起動
.\install_service.ps1 -Start
```

### バックアップ
```powershell
# データベースバックアップ
$BackupDir = "backup\$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Path $BackupDir
Copy-Item database\*.db $BackupDir\
```

## まとめ

Windows 11 25H2環境で動作する、完全閉域型セキュアLLMエージェントシステム。
医療・金融・ビジネス・情報システム・防衛・航空宇宙・運輸の全分野に対応し、
三重推論による安全性保証、完全監査、マルチモーダル対応を実現。

**キーポイント**:
- **閉域運用**: ollama/lmstudioSDK MCPのみ通信
- **完全監査**: Windows Event Log + SQLite
- **ESCALATE優先**: 不明瞭・危険は必ず人間確認
- **マルチモーダル**: テキスト+画像+動画対応
- **日本企業特化**: 業務・法規制・文化対応

---

**作成日**: 2025-11-06  
**対象バージョン**: SO8T v1.0  
**ステータス**: 本番配備可能
