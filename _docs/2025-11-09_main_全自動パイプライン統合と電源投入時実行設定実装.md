# 全自動パイプライン統合と電源投入時実行設定実装ログ

## 実装情報
- **日付**: 2025-11-09
- **Worktree**: main
- **機能名**: 全自動パイプライン統合と電源投入時実行設定
- **実装者**: AI Agent

## 実装内容

### 1. 統合マスターパイプラインスクリプトの作成

**ファイル**: `scripts/pipelines/unified_master_pipeline.py` (新規作成)

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: すべての全自動パイプラインを統合して、電源投入時に自動実行できるようにする統合マスターパイプライン

#### Phase 1: 並列DeepResearch Webスクレイピング
- `parallel_pipeline_manager.py`を実行
- バックグラウンドで実行（daemon mode）
- データ収集を開始
- プロセスIDを記録

#### Phase 2: SO8T全自動データ処理
- `so8t_auto_data_processing_pipeline.py`を実行
- データクレンジング、漸次ラベル付け、四値分類を実行
- 設定ファイルを指定して実行

#### Phase 3: SO8T完全統合A/Bテスト
- `complete_so8t_ab_test_pipeline.py`を実行
- Model A/BのGGUF変換、Ollamaインポート、A/Bテストを実行
- 設定ファイルを指定して実行

#### 依存関係管理
- 各フェーズの完了を待ってから次のフェーズを開始
- チェックポイントで完了状態を確認
- 処理済みフェーズをスキップ

#### チェックポイント機能
- 各フェーズでチェックポイントを保存
- 中断から再開可能
- 処理済みフェーズをスキップ

#### エラーハンドリング
- フェーズごとのエラー処理
- 必須フェーズの失敗時は停止
- オプションフェーズの失敗時は続行

### 2. 電源投入時自動実行設定

**ファイル**: `scripts/pipelines/unified_master_pipeline.py` (統合)

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: Windowsタスクスケジューラ登録機能を実装

- `setup_auto_start()`関数を実装
- 管理者権限チェック
- `schtasks`コマンドでタスク登録
- バッチファイルを使用して261文字制限を回避
- タスク名: `SO8T-UnifiedMasterPipeline-AutoStart`
- トリガー: システム起動時（`onstart`）

### 3. バッチファイルの作成

**ファイル**: `scripts/pipelines/unified_master_pipeline_autostart.bat` (新規作成)

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: タスクスケジューラ用バッチファイル

- プロジェクトルートに移動
- Pythonパスの自動検出
- 統合マスターパイプラインを実行
- `--run`引数でタスクスケジューラから呼び出されたことを示す
- エラーハンドリング

### 4. 設定ファイルの作成

**ファイル**: `configs/unified_master_pipeline_config.yaml` (新規作成)

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 統合マスターパイプラインの設定をYAMLファイルで管理

#### 設定項目
- **基本設定**: セッションID形式、チェックポイントディレクトリ
- **Phase 1設定**: 並列スクレイピング設定（インスタンス数、出力ディレクトリ、ポートなど）
- **Phase 2設定**: データ処理設定（設定ファイルパス、タイムアウト）
- **Phase 3設定**: A/Bテスト設定（設定ファイルパス、タイムアウト）
- **タスクスケジューラ設定**: タスク名、トリガー、優先度

### 5. セットアップスクリプトの作成

**ファイル**: `scripts/pipelines/setup_unified_master_pipeline.bat` (新規作成)

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 統合マスターパイプラインのセットアップスクリプト

- 管理者権限チェック
- 設定ファイルの確認
- バッチファイルの確認
- タスクスケジューラ登録
- 音声通知（完了時）

## 作成・変更ファイル
- `scripts/pipelines/unified_master_pipeline.py` (新規作成)
- `scripts/pipelines/unified_master_pipeline_autostart.bat` (新規作成)
- `configs/unified_master_pipeline_config.yaml` (新規作成)
- `scripts/pipelines/setup_unified_master_pipeline.bat` (新規作成)
- `_docs/2025-11-09_main_全自動パイプライン統合と電源投入時実行設定実装.md` (新規作成)

## 設計判断

### パイプライン実行順序
1. **Phase 1**: 並列DeepResearch Webスクレイピング（データ収集）
2. **Phase 2**: SO8T全自動データ処理（データクレンジング、ラベル付け、分類）
3. **Phase 3**: SO8T完全統合A/Bテスト（モデル比較、評価）

### 依存関係管理
- Phase 1の完了を待ってからPhase 2を開始
- Phase 2の完了を待ってからPhase 3を開始
- 各フェーズの完了をチェックポイントで確認

### エラーハンドリング
- フェーズごとのエラー処理
- 必須フェーズの失敗時は停止
- オプションフェーズの失敗時は続行

### チェックポイント機能
- 各フェーズでチェックポイントを保存
- 中断から再開可能
- 処理済みフェーズをスキップ

### Phase 1のバックグラウンド実行
- Phase 1はバックグラウンドで実行（daemon mode）
- プロセスIDを記録
- すぐにPhase 2に進む（データ収集は継続）

## 使用方法

### セットアップ（初回のみ）
```bash
# 管理者として実行
scripts\pipelines\setup_unified_master_pipeline.bat

# または、Pythonスクリプトを直接実行
py -3 scripts\pipelines\unified_master_pipeline.py --setup --config configs\unified_master_pipeline_config.yaml
```

### 手動実行
```bash
# Pythonスクリプトを直接実行
py -3 scripts\pipelines\unified_master_pipeline.py --run --config configs\unified_master_pipeline_config.yaml
```

### 設定ファイルのカスタマイズ
```yaml
# configs/unified_master_pipeline_config.yaml
phase1_parallel_scraping:
  enabled: true
  required: true
  num_instances: 10
phase2_data_processing:
  enabled: true
  required: true
phase3_ab_test:
  enabled: true
  required: false  # オプションフェーズ
```

## 出力

- **チェックポイント**: `D:/webdataset/checkpoints/unified_master_pipeline/checkpoint_{session_id}.pkl`
- **Phase 1出力**: `D:/webdataset/processed/`（並列スクレイピングデータ）
- **Phase 2出力**: `D:/webdataset/processed/four_class/`（処理済みデータ）
- **Phase 3出力**: `D:/webdataset/ab_test_results/complete_so8t_ab_test_{session_id}/`（A/Bテスト結果）

## 技術詳細

### パイプライン実行順序
1. **Phase 1**: 並列DeepResearch Webスクレイピング（バックグラウンド実行）
2. **Phase 2**: SO8T全自動データ処理（順次実行）
3. **Phase 3**: SO8T完全統合A/Bテスト（順次実行）

### 依存関係管理
- Phase 1の完了を待ってからPhase 2を開始
- Phase 2の完了を待ってからPhase 3を開始
- 各フェーズの完了をチェックポイントで確認

### エラーハンドリング
- フェーズごとのエラー処理
- 必須フェーズの失敗時は停止
- オプションフェーズの失敗時は続行

### チェックポイント機能
- 各フェーズでチェックポイントを保存
- 中断から再開可能
- 処理済みフェーズをスキップ

### 電源投入時自動実行
- Windowsタスクスケジューラに登録
- システム起動時に自動実行
- 60秒の遅延処理（システム起動待機）

## 運用注意事項

### データ収集ポリシー
- 利用条件を守りつつ、高信頼ソースとして優先使用
- robots.txt遵守を徹底
- 個人情報・機密情報の除外を徹底

### NSFWコーパス運用
- **主目的**: 安全判定と拒否挙動の学習（生成目的ではない）
- モデル設計とドキュメントに明記
- 分類器は検出・拒否用途のみ

### /thinkエンドポイント運用
- 四重Thinking部（`<think-*>`）は外部非公開を徹底
- `<final>`のみ返す実装を維持
- 監査ログでThinkingハッシュを記録（内容は非公開）

### パイプライン運用
- **自動実行**: 電源投入時に自動実行
- **実行時間**: 数時間から数日かかる場合があります
- **チェックポイント**: 各フェーズで自動保存
- **再開機能**: 中断から自動的に再開可能
- **音声通知**: 各フェーズ完了時に音声通知を再生

### 管理者権限
- **セットアップ時**: 管理者権限が必要（タスクスケジューラ登録のため）
- **実行時**: 通常のユーザー権限で実行可能

## 次のステップ

1. **動作確認**: 実際の環境でパイプラインを実行して動作確認
2. **パフォーマンス最適化**: 処理速度の最適化
3. **エラーハンドリング改善**: エラー発生時の処理を改善
4. **統合テスト**: 他のパイプラインとの統合テスト
5. **監視機能**: パイプラインの実行状況を監視する機能の追加

