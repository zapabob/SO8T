# Git LFS ディスク容量不足問題解決ログ

## 実装日時
2025-11-07

## 問題概要

Borea-Phi-3.5-mini-Instruct-CommonモデルのGit LFSクローン時に、以下のエラーが発生：

```
error: unable to write file model-00001-of-00002.safetensors
fatal: unable to checkout working tree
warning: Clone succeeded, but checkout failed.
```

## 原因分析

### 1. ディスク容量不足
- **Cドライブ空き容量**: 3.38 GB
- **必要な容量**: 
  - `model-00001-of-00002.safetensors`: 3.62 GB
  - `model-00002-of-00002.safetensors`: 2.49 GB
  - **合計**: 約6.11 GB

### 2. Git LFSファイル管理
- `.gitattributes`で`*.safetensors`がGit LFSで管理されている
- ファイルは正常にフェッチされているが、チェックアウト時に書き込み失敗

### 3. メモリ不足
- `git reset --hard HEAD`実行時に「Out of memory」エラー発生

## 解決策

### 方法1: ディスク容量確保（推奨）

#### 一時ファイルクリーンアップ
```powershell
# 7日以上古い一時ファイルを削除
py -3 scripts/fix_borea_git_lfs.ps1 -CleanTemp
```

#### ディスククリーンアップツール使用
- Windowsの「ディスククリーンアップ」ツール実行
- システムファイルのクリーンアップ
- ダウンロードフォルダの整理

### 方法2: 別ドライブへの移動

#### 自動移動スクリプト
```powershell
# Dドライブに移動
py -3 scripts/fix_borea_git_lfs.ps1 -TargetDrive D
```

#### 手動移動
```powershell
# 1. モデルディレクトリをDドライブに移動
Move-Item -Path "C:\Users\downl\Desktop\SO8T\Borea-Phi-3.5-mini-Instruct-Common" -Destination "D:\SO8T\Borea-Phi-3.5-mini-Instruct-Common" -Force

# 2. シンボリックリンク作成（オプション）
New-Item -ItemType SymbolicLink -Path "C:\Users\downl\Desktop\SO8T\Borea-Phi-3.5-mini-Instruct-Common" -Target "D:\SO8T\Borea-Phi-3.5-mini-Instruct-Common"
```

### 方法3: HuggingFaceから直接ダウンロード

Git LFSを使わず、HuggingFaceから直接ダウンロード：

```python
from transformers import AutoModelForCausalLM, AutoTokenizer

# モデルを直接ダウンロード（Git LFS不要）
model = AutoModelForCausalLM.from_pretrained(
    "HODACHI/Borea-Phi-3.5-mini-Instruct-Common",
    cache_dir="D:/models"  # 別ドライブに保存
)
```

## 実装ファイル

### `scripts/fix_borea_git_lfs.ps1`
- ディスク容量確認
- 一時ファイルクリーンアップ
- 別ドライブへの移動
- Git LFS再取得
- 最終確認

## 実行手順

### 1. ディスク容量確認
```powershell
Get-PSDrive -PSProvider FileSystem | Select-Object Name, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}
```

### 2. 修復スクリプト実行
```powershell
# 一時ファイルクリーンアップ + 修復
py -3 scripts/fix_borea_git_lfs.ps1 -CleanTemp

# 別ドライブへの移動
py -3 scripts/fix_borea_git_lfs.ps1 -TargetDrive D
```

### 3. Git LFS再取得
```powershell
cd Borea-Phi-3.5-mini-Instruct-Common
git lfs fetch --all
git lfs checkout
git lfs pull
```

## 予防策

### 1. ディスク容量監視
- 定期的なディスク容量チェック
- 10GB以下の空き容量で警告

### 2. モデル保存場所の最適化
- 大きなモデルは別ドライブ（D/E）に保存
- シンボリックリンクでアクセス

### 3. Git LFS設定確認
- `.gitattributes`で適切なファイルがLFS管理されているか確認
- LFSキャッシュサイズの調整

## 現在の状態

- [x] すべてのsafetensorsファイルが正常に存在
  - `model-00001-of-00002.safetensors`: 3.62 GB
  - `model-00002-of-00002.safetensors`: 2.49 GB
- [ ] ディスク容量確保（10GB以上推奨） - **緊急対応必要**
  - Cドライブ空き容量: 0 GB（深刻な問題）
  - Dドライブ空き容量: 347.95 GB（十分）
  - Eドライブ空き容量: 368.07 GB（十分）
- [ ] Git LFS再取得完了（ファイルは存在しているが、Git状態が不整合）
- [ ] モデルが正常に読み込める（要確認）

## 次のステップ

### 緊急対応（優先度：最高）
1. **Cドライブの容量確保** - システムが正常に動作するため、最低10GB以上の空き容量が必要
   - 一時ファイルの削除
   - 不要なアプリケーションのアンインストール
   - ディスククリーンアップツールの実行

### モデル関連
2. Git LFS状態の修復（オプション）
   - ファイルは既に存在しているため、Git状態の修復は後回しでも可
3. モデルの正常性確認
   - `scripts/convert_borea_to_gguf.py`でモデルが正常に読み込めるか確認
4. Borea完全パイプライン実行再開

### 推奨対応
- 大きなモデルファイルはD/Eドライブに移動することを推奨
- シンボリックリンクを使用して元のパスからアクセス可能にする

## 参考情報

- Git LFS公式ドキュメント: https://git-lfs.github.com/
- HuggingFaceモデルページ: https://huggingface.co/HODACHI/Borea-Phi-3.5-mini-Instruct-Common
- Windowsシンボリックリンク: https://docs.microsoft.com/en-us/windows/win32/fileio/symbolic-links

