# 電源断リカバリー自動再開機能実装ログ

## 実装日時
2025-11-07

## 概要
電源オン時に学習とクロールを自動的に再開する機能を実装しました。既存のリカバリー機能を活用し、セッションファイルを自動検出して再開します。

## 実装内容

### 1. 自動再開スクリプト (`scripts/auto_resume.py`)
- セッションファイルの自動検出機能
  - 学習セッション: `checkpoints/training/training_session.json`
  - クロールセッション: `data/checkpoints/session.json`
- 学習とクロールの状態確認
- 自動再開ロジック
  - セッションファイルが存在し、未完了の場合に自動再開
  - 最新チェックポイントから復旧
  - セッション有効期限チェック（7日間）
  - 完了済みセッションは自動再開しない

### 2. Windowsスタートアップスクリプト (`scripts/auto_resume_startup.bat`)
- 電源オン時に自動実行されるバッチファイル
- UTF-8エンコーディング設定 (`chcp 65001`)
- 自動再開スクリプトの呼び出し
- ログ出力とエラーハンドリング
- 音声通知機能

### 3. タスクスケジューラー登録スクリプト (`scripts/setup_auto_resume.bat`)
- Windowsタスクスケジューラーに自動実行タスクを登録
- ログイン時に自動実行される設定
- 管理者権限チェック
- タスクの詳細表示

### 4. 既存スクリプトの拡張

#### `scripts/train_so8t_recovery.py`
- `--auto-resume`オプション追加
- セッションファイル自動検出機能
- 最新チェックポイントの自動検索

#### `so8t-mmllm/scripts/data/collect_japanese_data.py`
- `--auto-resume`オプション追加
- セッションファイルが存在する場合、自動的に復旧
- 既存セッションから目標サンプル数を取得

### 5. セッション管理の改善

#### `TrainingSession` (`so8t-mmllm/scripts/training/train_so8t_ja_full.py`)
- `completed`フラグ追加
- `end_time`フィールド追加
- `mark_completed()`メソッド追加
- 後方互換性のためのデフォルト値設定

#### `CollectionSession` (`so8t-mmllm/scripts/data/collect_japanese_data.py`)
- `completed`フラグ追加
- `end_time`フィールド追加
- `mark_completed()`メソッド追加
- 後方互換性のためのデフォルト値設定

#### 完了マーク処理
- 学習完了時: `session.mark_completed()`を呼び出し
- クロール完了時: `_finalize()`メソッドで完了マーク

## 実装ファイル

### 新規作成
- `scripts/auto_resume.py`: 自動再開メインスクリプト
- `scripts/auto_resume_startup.bat`: Windowsスタートアップスクリプト
- `scripts/setup_auto_resume.bat`: タスクスケジューラー登録スクリプト

### 修正
- `scripts/train_so8t_recovery.py`: 自動再開モード追加
- `so8t-mmllm/scripts/data/collect_japanese_data.py`: 自動再開モード追加
- `so8t-mmllm/scripts/training/train_so8t_ja_full.py`: セッション管理改善

## 使用方法

### 1. タスクスケジューラー登録
```batch
cd C:\Users\downl\Desktop\SO8T
scripts\setup_auto_resume.bat
```

### 2. 手動実行（テスト用）
```batch
cd C:\Users\downl\Desktop\SO8T
scripts\auto_resume_startup.bat
```

### 3. 自動再開スクリプト直接実行
```bash
py -3 scripts/auto_resume.py
```

### 4. 学習スクリプトで自動再開
```bash
py -3 scripts/train_so8t_recovery.py --auto-resume
```

### 5. クロールスクリプトで自動再開
```bash
py -3 so8t-mmllm/scripts/data/collect_japanese_data.py --auto-resume
```

## 機能詳細

### セッション検出
- 複数のセッションファイルパスを検索
- セッション有効期限チェック（7日間）
- 完了済みセッションのスキップ
- 進捗状況の表示

### 自動再開
- 最新チェックポイントから復旧
- バックグラウンド実行
- ログ出力
- エラーハンドリング

### セッション管理
- 完了フラグによる自動再開防止
- セッション有効期限による古いセッションの無視
- 後方互換性の維持

## 注意事項
- Windowsタスクスケジューラーでログイン時に実行する設定が必要
- セッションファイルのパスは絶対パスで管理
- エラーハンドリングを適切に実装
- ログファイルは `logs/auto_resume.log` に保存
- セッション有効期限は7日間（設定可能）

## テスト項目
- [ ] セッションファイルの自動検出
- [ ] 学習の自動再開
- [ ] クロールの自動再開
- [ ] 完了済みセッションのスキップ
- [ ] セッション有効期限チェック
- [ ] タスクスケジューラー登録
- [ ] ログ出力確認

## 今後の改善点
- セッション有効期限の設定ファイル化
- 再開前の確認プロンプト（オプション）
- 複数セッションの優先順位管理
- 再開失敗時の通知機能

