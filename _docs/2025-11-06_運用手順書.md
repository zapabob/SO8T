# SO8T統合セキュアLLMシステム 運用手順書

## 対象ドメイン
- 防衛・航空宇宙・運輸（既存）
- **医療**: カルテ管理、診断支援、画像分析
- **金融**: 取引監視、不正検知、コンプライアンス
- **ビジネス**: オフィス作業支援、文書管理、会議要約
- **情報システム**: ログ監視、セキュリティ監視、異常検知
- **一般**: 日本企業向け汎用業務支援

## システム概要

### アーキテクチャ
```
[ユーザー] ↔ [Windows MCPエージェント] ↔ [Ollama/LMStudio]
                      ↓
    ┌─────────────────────────────────┐
    │ SO8T統合Phi-4日本語特化LLM     │
    │ - 三重推論（ALLOW/ESCALATE/DENY）│
    │ - identity_contract管理         │
    │ - policy_state管理              │
    │ - decision_log追跡              │
    └─────────────────────────────────┘
                      ↓
    ┌─────────────────────────────────┐
    │ 統合セキュリティレイヤー        │
    │ - マルウェア検知                │
    │ - 監視カメラ統合                │
    │ - ネットワーク監視              │
    │ - カルテ管理（医療）            │
    │ - 情報ストア（閉域ベクトルDB）  │
    └─────────────────────────────────┘
                      ↓
    ┌─────────────────────────────────┐
    │ 完全監査システム                │
    │ - Windows Event Log統合         │
    │ - SQLite監査ログ                │
    │ - エビングハウス復習管理        │
    │ - コンプライアンスレポート      │
    └─────────────────────────────────┘
```

## セットアップ手順

### 1. 環境準備

#### 必要環境
- **OS**: Windows 11 25H2以降
- **GPU**: RTX3080 12GB以上（CUDA 12.x）
- **RAM**: 32GB以上推奨
- **ストレージ**: 100GB以上（モデル・データ用）
- **Python**: 3.10以上
- **Ollama**: 最新版

#### 依存関係インストール
```bash
# プロジェクトディレクトリ
cd C:\Users\downl\Desktop\SO8T

# Python依存関係
py -3 -m pip install -r requirements.txt

# 追加パッケージ
py -3 -m pip install opencv-python pytesseract psutil transformers datasets peft bitsandbytes tqdm
```

### 2. 完全パイプライン実行

#### オプション1: 自動実行（推奨）
```bash
cd so8t-mmllm\scripts
run_full_pipeline.bat
```

#### オプション2: 手動実行（段階的）

##### Phase 1: データ収集（6-12時間）
```bash
# 公開データ収集
py -3 so8t-mmllm\scripts\data\collect_japanese_data.py --target 100000

# 合成データ生成
py -3 so8t-mmllm\scripts\data\generate_synthetic_data.py --samples 25000

# マルチモーダル合成データ
py -3 so8t-mmllm\scripts\data\generate_multimodal_synthetic.py --samples 25000

# 品質検証
py -3 so8t-mmllm\scripts\data\validate_data_quality.py
```

##### Phase 2: 学習実行（33時間）
```bash
cd so8t-mmllm\scripts\training
start_training.bat
```

##### Phase 3: GGUF変換・Ollama配備
```bash
py -3 so8t-mmllm\scripts\convert_to_gguf_full.py
```

##### Phase 4: モデル評価
```bash
# 3モデル比較
py -3 so8t-mmllm\scripts\evaluation\compare_models.py

# 包括的評価
py -3 so8t-mmllm\scripts\evaluation\comprehensive_evaluation.py
```

##### Phase 5: Windows MCPサービス配備
```powershell
# サービスインストール
cd so8t-mmllm\scripts\windows
.\install_service.ps1 -Install

# サービス起動
.\install_service.ps1 -Start

# ステータス確認
.\install_service.ps1 -Status
```

### 3. モデル使用方法

#### Ollamaコマンドライン
```bash
# モデル一覧
ollama list

# 基本推論
ollama run so8t-phi4-so8t-ja-finetuned-q4_k_m "日本語で質問してください"

# 温度パラメータ調整
ollama run so8t-phi4-so8t-ja-finetuned-q4_k_m --temperature 0.5 "質問"

# 用途別推奨温度
# - 一般タスク: 0.7
# - 専門回答: 0.5
# - 創造的生成: 1.0
# - 安全判定: 0.3
```

#### Pythonスクリプト（MCP経由）
```python
from src.agents.windows_mcp_agent import WindowsMCPAgent, DEFAULT_IDENTITY_CONTRACT, DEFAULT_POLICY_STATE

# エージェント初期化
agent = WindowsMCPAgent(
    identity_contract=DEFAULT_IDENTITY_CONTRACT,
    policy_state=DEFAULT_POLICY_STATE,
    model_name="so8t-phi4-so8t-ja-finetuned-q4_k_m"
)

# クエリ処理
result = agent.process_query("防衛システムについて教えてください")
print(f"Decision: {result['parsed']['decision']}")
print(f"Response: {result['response']}")
```

## ドメイン別運用ガイド

### 医療（Medical）

#### カルテ管理
```python
from src.medical.electronic_medical_record import ElectronicMedicalRecordSystem

emr = ElectronicMedicalRecordSystem()

# カルテ追加
record = emr.process_medical_image(
    image_path=Path("patient_chart.jpg"),
    patient_id="PATIENT001"
)
emr.add_record(record, user_id="DOC001")

# 診断支援（必ずESCALATE）
assistance = emr.provide_diagnosis_assistance(record.record_id)
```

#### セキュリティ要件
- **機密レベル**: 極秘（個人情報保護法遵守）
- **アクセス制御**: 医療従事者のみ
- **監査**: 全アクセス記録（Windows Event Log統合）
- **判断**: 診断支援は必ずESCALATE（医師確認必須）

### 金融（Finance）

#### 不正検知
```python
from src.agents.windows_mcp_agent import WindowsMCPAgent

# 金融エージェント
agent = WindowsMCPAgent(...)

# 取引監視
result = agent.process_query("この取引は正常ですか？")
# → 判断: ESCALATE（専門家確認必要）
```

#### セキュリティ要件
- **機密レベル**: 機密（金融商品取引法遵守）
- **監査**: 全取引記録
- **判断**: リスク評価は必ずESCALATE

### ビジネス（Business）

#### オフィスアシスタント
```python
# 会議要約
result = agent.process_query("この会議の要点をまとめてください")

# メール下書き
result = agent.process_query("取引先への提案メールを書いてください")
```

#### セキュリティ要件
- **機密レベル**: 取扱注意
- **監査**: アクセスログ記録
- **判断**: 契約・承認事項はESCALATE

### 情報システム（Information System）

#### セキュリティ監視
```python
from src.agents.malware_detector import MalwareDetectorAgent

detector = MalwareDetectorAgent()

# リアルタイム監視
detector.start_monitoring(interval=60)

# レポート生成
detector.generate_report()
```

#### ネットワーク監視
- **MCP通信例外**: ollama（11434）、lmstudioSDK（8080）のみ許可
- **外部通信遮断**: その他の外部接続は全てESCALATE
- **ログ収集**: 全ネットワークイベント記録

### 監視カメラ統合

#### 不審者・危険検知
```python
from src.agents.visual_detection_agent import VisualDetectionAgent

detector = VisualDetectionAgent()

# カメラ監視開始
detector.start_camera_monitoring(camera_id=0, interval=5)

# 画像処理
detections = detector.process_image(Path("camera_frame.jpg"))
```

#### 検知機能
- **不審者検知**: 顔認識ベース
- **異物混入検知**: 差分検出
- **危険検知**: 色ベース（赤色→火災・血液）
- **判断**: 検知時は原則ESCALATE

## 監査・コンプライアンス

### Windows Event Log統合
```powershell
# Event Logソース登録（初回のみ）
New-EventLog -LogName Application -Source "SO8T"

# イベント確認
Get-EventLog -LogName Application -Source "SO8T" -Newest 100
```

### コンプライアンスレポート生成
```python
from src.audit.enhanced_audit_logger import EnhancedAuditLogger
from datetime import datetime, timedelta

logger = EnhancedAuditLogger()

# 月次レポート
start_date = datetime.now() - timedelta(days=30)
end_date = datetime.now()
report = logger.generate_compliance_report(start_date, end_date)

print(f"Compliance Score: {report.compliance_score:.2%}")
```

### エビングハウス復習管理
```python
# 復習必要なイベント取得
events = logger.get_events_for_review()

# 保持率更新（定期実行推奨：毎日）
logger.update_retention_scores()
```

## トラブルシューティング

### 学習が失敗する
- **原因**: メモリ不足、CUDA error
- **対処**: 
  - バッチサイズ削減（2→1）
  - 勾配蓄積増加（8→16）
  - チェックポイントから再開

### Ollama配備エラー
- **原因**: Ollama未起動、GGUFファイル破損
- **対処**:
  - `ollama serve` でサーバー起動確認
  - GGUFファイル再変換

### MCP通信エラー
- **原因**: ポート競合、サービス未起動
- **対処**:
  - ポート11434（ollama）、8080（lmstudio）確認
  - サービス再起動

### カメラ検知エラー
- **原因**: カメラアクセス権限、ドライバー
- **対処**:
  - 管理者権限で実行
  - カメラID変更（0→1）

## 性能チューニング

### GPU最適化
```python
# 混合精度（bf16）
config["bf16"] = True

# グラディエントチェックポイント
config["gradient_checkpointing"] = True

# Flash Attention（対応モデルのみ）
config["use_flash_attention"] = True
```

### メモリ最適化
- **8bit量子化**: 有効化済み
- **LoRA**: r=64で最適バランス
- **勾配蓄積**: 8ステップ（実質バッチサイズ16）

### 推論高速化
- **量子化**: Q4_K_M（速度重視）、Q8_0（精度重視）
- **焼きこみ**: 推論時オーバーヘッド0%
- **温度較正**: ECE最小化で過確信抑制

## セキュリティ運用

### アクセス制御
- **機密レベル**: 公開/取扱注意/機密/極秘
- **ユーザークリアランス**: レベル別アクセス権
- **監査**: 全アクセス記録（拒否も含む）

### 情報漏洩防止
- **閉域運用**: 外部API不使用
- **ローカルベクトルDB**: FAISS/ChromaDB（オフライン）
- **MCP通信制限**: ollama/lmstudioのみ許可
- **ネットワーク監視**: 異常通信即座検知

### コンプライアンス
- **医療**: 個人情報保護法、医療法
- **金融**: 金融商品取引法、銀行法
- **一般**: 個人情報保護法、不正競争防止法

## 定期メンテナンス

### 日次
- エビングハウス保持率更新
- マルウェアスキャン
- ログローテーション

### 週次
- コンプライアンスレポート生成
- 異常検知レビュー
- パフォーマンス監視

### 月次
- モデル精度評価
- データセット品質確認
- セキュリティ監査

## サポート・問い合わせ

### ログファイル確認
- **学習**: `logs/training_*.log`
- **評価**: `logs/pipeline_*/`
- **監査**: `database/*.db`（SQLite Browser使用）

### レポート確認
- **場所**: `_docs/*.md`
- **種類**: 
  - データ収集レポート
  - 学習レポート
  - GGUF変換レポート
  - モデル比較レポート
  - マルウェア検知レポート
  - コンプライアンスレポート
  - 包括的評価レポート

### 緊急時対応
1. **サービス停止**: `.\install_service.ps1 -Stop`
2. **ログ確認**: `Get-EventLog -LogName Application -Source "SO8T"`
3. **データベースバックアップ**: `database/*.db`をコピー
4. **チェックポイント復旧**: `checkpoints/training/`から最新復元

## ベストプラクティス

### 判断原則
- **不明確な要求**: 必ずESCALATE
- **医療判断**: 常にESCALATE（医師確認必須）
- **金融承認**: 常にESCALATE（専門家確認必須）
- **危険検知**: 即座ESCALATE（人間確認）

### レスポンス構成
すべてのAI応答に以下を含める：
1. **提案（Proposal）**: 最小安全実行案
2. **リスク（Risks）**: 想定されるリスク列挙
3. **エスカレーション（Escalation）**: 誰に・どこまで確認が必要か
4. **根拠（Sources）**: identity_contract/policy_state/decision_log引用

### 一貫性保証
- 同一リスクには同一判断
- decision_logで過去判断参照
- 矛盾する判断は記録・レビュー

## まとめ

SO8T統合セキュアLLMシステムは、日本企業の閉域環境で安全に運用できる
包括的なLLMOpsプラットフォームです。

**重要原則**:
- 危険/不明瞭は**ESCALATE優先**
- すべての判断は**完全監査**
- 医療・金融判断は**必ず人間確認**
- 情報漏洩は**絶対防止**（閉域運用）

---

**作成日**: 2025-11-06  
**対象**: Windows 11 25H2、日本企業閉域環境  
**ステータス**: 本番配備準備完了

