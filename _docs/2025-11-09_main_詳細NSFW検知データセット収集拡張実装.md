# 詳細NSFW検知データセット収集拡張実装ログ

## 実装情報
- **日付**: 2025-11-09
- **Worktree**: main
- **機能名**: 詳細NSFW検知データセット収集拡張実装
- **実装者**: AI Agent

## 実装内容

### 1. 詳細カテゴリ分類の実装（23カテゴリ）

**ファイル**: `scripts/data/collect_nsfw_detection_dataset.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 6カテゴリから23カテゴリに拡張

#### 実装されたカテゴリ

1. **性的コンテンツ（3カテゴリ）**
   - `sexual_content_explicit`: 明示的性的コンテンツ
   - `sexual_content_implicit`: 暗示的性的コンテンツ
   - `sexual_content_educational`: 性教育（合法）

2. **暴力（3カテゴリ）**
   - `violence_graphic`: グラフィックな暴力描写
   - `violence_implied`: 暗示的暴力
   - `violence_educational`: 暴力に関する教育（合法）

3. **差別（4カテゴリ）**
   - `hate_speech_racial`: 人種差別
   - `hate_speech_gender`: 性差別
   - `hate_speech_religious`: 宗教差別
   - `hate_speech_other`: その他差別

4. **自傷行為（2カテゴリ）**
   - `self_harm_suicide`: 自殺関連
   - `self_harm_self_injury`: 自傷行為

5. **武器（3カテゴリ）**
   - `weapons_manufacturing`: 武器製造手順
   - `weapons_usage`: 武器使用手順
   - `weapons_educational`: 武器に関する教育（合法）

6. **医療助言（3カテゴリ）**
   - `medical_advice_diagnosis`: 診断に関する助言
   - `medical_advice_treatment`: 治療に関する助言
   - `medical_advice_educational`: 医学教育（合法）

7. **違法コンテンツ（5カテゴリ）**
   - `illegal_drugs`: 違法薬物
   - `illegal_financial`: 金融犯罪
   - `illegal_cybercrime`: サイバー犯罪
   - `child_exploitation`: 児童搾取
   - `privacy_violation`: プライバシー侵害

**主要機能**:
- `_classify_detailed_category()`: 詳細カテゴリ分類（文脈・意図・対象読者を考慮）
- 文脈依存カテゴリの自動判定（教育・学術的文脈の場合は安全と判定）
- 優先度順のカテゴリスコアリング

### 2. 詳細メタデータの追加

**ファイル**: `scripts/data/collect_nsfw_detection_dataset.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 文脈・意図・法的状態・対象読者・判定理由を含む詳細メタデータ

**追加されたメタデータ**:
- `context`: 文脈情報（医学教育、文学作品、学術研究など）
- `intent`: 意図情報（学術、芸術表現、教育など）
- `audience`: 対象読者（医学生、一般読者、研究者など）
- `legal_status`: 法的状態（safe, potentially_illegal, illegal, safe_but_harmful, context_dependent）
- `reasoning`: 判定理由（自動生成）
- `requires_human_review`: 人間による確認が必要かどうか

**主要機能**:
- `detect_nsfw()`: 拡張版NSFW検知（メタデータ対応）
- `_generate_reasoning()`: 判定理由の自動生成
- 文脈依存カテゴリの自動判定

### 3. 合成データ生成機能の実装

**ファイル**: `scripts/data/collect_nsfw_detection_dataset.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 倫理的、検知目的のみ（実際のNSFWコンテンツは含まない）

**合成データテンプレート**:
- 医学教育（合法）
- 文学作品（合法、文化的価値）
- 暴力防止教育（合法）
- 学術研究（合法）
- 軍事史研究（合法）

**主要機能**:
- `generate_synthetic_samples()`: 合成データ生成
- テンプレートベースのサンプル生成
- NSFW検知の自動実行とメタデータ付与

### 4. データセット拡張（最大50,000サンプル）

**ファイル**: `scripts/data/collect_nsfw_detection_dataset.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 最大サンプル数を10,000から50,000に拡張

**拡張内容**:
- `collect_from_existing_data()`: 最大サンプル数を50,000に拡張
- 安全サンプルの保存率を調整（2%保存）
- カテゴリ分布の自動確認とログ出力

### 5. 統合パイプラインへの統合

**ファイル**: `scripts/pipelines/unified_master_pipeline.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: Phase 11として統合パイプラインに追加

**統合内容**:
- `phase11_nsfw_detection_dataset()`: Phase 11の実装
- 設定ファイルからのパラメータ読み込み
- 合成データ生成オプションの追加
- 詳細メタデータオプションの追加

### 6. 設定ファイルの更新

**ファイル**: `configs/unified_master_pipeline_config.yaml`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: Phase 11の設定を拡張

**追加された設定**:
- `max_samples`: 50,000（拡張）
- `include_synthetic`: true（合成データを含める）
- `synthetic_samples`: 1,000（合成サンプル数）
- `include_metadata`: true（詳細メタデータを含める）
- `detailed_categories`: 詳細カテゴリ設定
- `data_sources`: データソース設定
- `timeout`: 14,400秒（4時間、拡張）

## 作成・変更ファイル

### 新規作成
- なし（既存ファイルの拡張）

### 変更ファイル
- `scripts/data/collect_nsfw_detection_dataset.py`: 詳細カテゴリ分類、詳細メタデータ、合成データ生成を追加
- `scripts/pipelines/unified_master_pipeline.py`: Phase 11の拡張パラメータ対応
- `configs/unified_master_pipeline_config.yaml`: Phase 11の設定を拡張

## 設計判断

### 1. 詳細カテゴリ分類の設計

**判断理由**:
- より細かい分類により、検知精度の向上が期待できる
- 文脈依存カテゴリ（教育・学術）を分離することで、誤検知を削減
- 23カテゴリにより、多様なNSFWコンテンツを適切に分類可能

**実装方針**:
- 各カテゴリに`context_required`フラグを追加
- 文脈依存カテゴリの場合は、文脈・意図・対象読者を確認してスコアを調整
- 教育・学術的文脈の場合はスコアを0.3倍に下げる

### 2. 詳細メタデータの設計

**判断理由**:
- 文脈・意図・法的状態・対象読者・判定理由を含むことで、検知モデルの学習精度が向上
- 人間による確認が必要なケースを自動判定可能
- データセットの品質向上と検知精度の向上が期待できる

**実装方針**:
- `detect_nsfw()`メソッドにメタデータパラメータを追加
- 判定理由を自動生成する`_generate_reasoning()`メソッドを実装
- メタデータを含むかどうかを設定で制御可能に

### 3. 合成データ生成の設計

**判断理由**:
- 実際のNSFWコンテンツを使わずに、検知モデルを学習可能
- 文脈・意図・法的境界を学習するための多様なサンプルを生成
- 倫理的かつ合法的なデータセット構築が可能

**実装方針**:
- テンプレートベースの合成データ生成
- 実際のNSFWコンテンツは含まない（検知目的のみ）
- 各テンプレートに期待カテゴリと期待判定を設定

### 4. データセット拡張の設計

**判断理由**:
- より多くのサンプルにより、検知精度の向上が期待できる
- 各カテゴリのバランス調整が可能
- 多様なサンプルにより、検知モデルの汎化性能が向上

**実装方針**:
- 最大サンプル数を50,000に拡張
- 安全サンプルの保存率を調整（2%保存）
- カテゴリ分布の自動確認とログ出力

## テスト結果

### 実装完了確認

- [x] 詳細カテゴリ分類（23カテゴリ）の実装
- [x] 詳細メタデータの追加
- [x] 合成データ生成機能の実装
- [x] データセット拡張（最大50,000サンプル）
- [x] 統合パイプラインへの統合
- [x] 設定ファイルの更新

### 動作確認

**動作確認**: [未確認]  
**確認日時**: -  
**備考**: 実装完了。実際のデータセット収集と検知精度の評価が必要

## 運用注意事項

### データ収集ポリシー
- 利用条件を守りつつ、高信頼ソースとして優先使用
- robots.txt遵守を徹底
- 個人情報・機密情報の除外を徹底

### NSFWコーパス運用
- **主目的**: 安全判定と拒否挙動の学習（生成目的ではない）
- モデル設計とドキュメントに明記
- 分類器は検出・拒否用途のみ
- 合成データは実際のNSFWコンテンツを含まない（検知目的のみ）

### /thinkエンドポイント運用
- 四重Thinking部（`<think-*>`）は外部非公開を徹底
- `<final>`のみ返す実装を維持
- 監査ログでThinkingハッシュを記録（内容は非公開）

## 今後の改善点

1. **データソースの拡張**
   - 公開裁判例（最高裁・高裁判決）からの収集
   - 行政指導事例（警察庁・消費者庁）からの収集
   - SNS利用規約違反事例（匿名化）からの収集
   - 文学作品・映画（検閲歴史）からの収集
   - 学術論文（法学・社会学）からの収集

2. **検知精度の評価**
   - 実際のデータセット収集と検知精度の評価
   - 各カテゴリの検知精度の評価
   - 誤検知率・見逃し率の評価

3. **メタデータの拡張**
   - より詳細な文脈情報の追加
   - 法的状態の詳細化
   - 判定理由の改善

4. **合成データの拡張**
   - より多様なテンプレートの追加
   - 文脈・意図・法的境界のバリエーション拡張
   - 検知精度向上のための多様なサンプル生成

## まとめ

詳細NSFW検知データセット収集機能を拡張し、以下の機能を実装しました：

1. **詳細カテゴリ分類（23カテゴリ）**: 6カテゴリから23カテゴリに拡張
2. **詳細メタデータ**: 文脈・意図・法的状態・対象読者・判定理由を含む
3. **合成データ生成**: 倫理的、検知目的のみの合成データ生成
4. **データセット拡張**: 最大サンプル数を50,000に拡張
5. **統合パイプライン統合**: Phase 11として統合パイプラインに追加

これにより、より具体的で詳細な検知用NSFWデータセットの収集が可能になりました。

