# PEFT 0.18.0勾配計算エラー修正（Forward Hook実装）

## 実装情報
- **日付**: 2025-11-15
- **Worktree**: main
- **機能名**: PEFT 0.18.0勾配計算エラー修正（Forward Hook実装）
- **実装者**: AI Agent

## 実装内容

### 問題分析

#### 問題1: `requires_grad=False`エラー
- PEFT 0.18.0では`enable_input_require_grads`が存在しない
- `outputs.logits`と`hidden_states`が`requires_grad=False`になり、勾配計算エラーが発生
- `RuntimeError: element 0 of tensors does not require grad and does not have a grad_fn`

#### 問題2: `past_key_values`警告
- `past_key_values should not be None in from_legacy_cache()`警告が発生
- Transformers v4.43以降では、`past_key_values`をタプルとして渡すことが非推奨
- 訓練時には`past_key_values`は通常`None`なので、警告を抑制する必要がある

### 実装項目

#### 1. Embedding層にForward Hookを登録

**ファイル**: `scripts/training/train_borea_phi35_so8t_thinking.py`

**実装状況**: [実装済み]  
**動作確認**: [要修正]  
**確認日時**: -  
**備考**: Forward hookで`output.requires_grad_(True)`を呼び出しているが、既に計算グラフから外れているテンソルには効果がない。より確実な方法が必要。

**変更内容**:
- Lines 339-395: Embedding層にforward hookを登録して`requires_grad=True`を設定
- Hook内で`output.requires_grad_(True)`を呼び出す
- ただし、これだけでは不十分な場合があるため、損失計算時に`hidden_states`から直接損失を再計算するフォールバック処理も実装

#### 2. `past_key_values`警告の処理

**ファイル**: `scripts/training/train_borea_phi35_so8t_thinking.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: `use_cache=False`と`past_key_values=None`を明示的に設定して警告を回避

**変更内容**:
- Lines 375-385: `inputs_with_hidden`に`use_cache=False`と`past_key_values=None`を追加

#### 3. エラーハンドリングの改善

**ファイル**: `scripts/training/train_borea_phi35_so8t_thinking.py`

**実装状況**: [実装済み]  
**動作確認**: [要修正]  
**確認日時**: -  
**備考**: `hidden_states`が`requires_grad=False`の場合のフォールバック処理を改善

**変更内容**:
- Lines 534-568: 最終的な損失検証部分を改善
- Forward hookが機能しなかった場合のフォールバック処理を追加
- より詳細なログ出力を追加

#### 4. SO(8)群構造パラメータの`requires_grad`設定

**ファイル**: `scripts/training/train_borea_phi35_so8t_thinking.py`

**実装状況**: [実装済み]  
**動作確認**: [未確認]  
**確認日時**: -  
**備考**: SO(8)群の回転行列パラメータ（`rotation_params`, `rotation_angles`など）は学習可能パラメータとして維持する必要がある。PEFT LoRAの`target_modules`に含まれないため、手動で`requires_grad=True`を設定する。

**変更内容**:
- Lines 1101-1112: `get_peft_model`の後に、SO(8)群構造のパラメータに`requires_grad=True`を設定
- SO(8)群構造に関連するパラメータ（`rotation`, `so8`, `group_structure`, `pet`, `so8t`を含むパラメータ名）を検索して設定
- 設定されたパラメータ数をログ出力

### DeepResearch結果

#### PEFT 0.18.0でのベストプラクティス

1. **`enable_input_require_grads`が存在しない**
   - PEFT 0.18.0では`enable_input_require_grads`が削除された
   - 代わりに、`prepare_model_for_kbit_training`と`get_peft_model`が自動的に設定するはずだが、実際には設定されていない

2. **Forward Hookの制限**
   - Forward hookで`output.requires_grad_(True)`を呼び出しても、既に計算グラフから外れているテンソルには効果がない
   - より確実な方法は、embedding層のパラメータ自体に`requires_grad=True`を設定するか、またはモデルのforwardメソッドをラップすること

3. **LoRAパラメータの`requires_grad`**
   - LoRAパラメータが`requires_grad=False`になる問題も報告されている
   - `get_peft_model`の後に、LoRAパラメータの`requires_grad`を確認する必要がある

### 実装完了項目

1. **SO(8)群構造パラメータに`requires_grad=True`を設定**（実装済み）
   - `get_peft_model`の後に、SO(8)群構造のパラメータ（`rotation_params`, `rotation_angles`など）に`requires_grad=True`を設定
   - SO(8)群の回転行列パラメータは学習可能パラメータとして維持する必要がある
   - PEFT LoRAの`target_modules`に含まれないため、手動で設定する
   - 実装箇所: `scripts/training/train_borea_phi35_so8t_thinking.py` Lines 1101-1112

2. **Embedding層のパラメータに`requires_grad=True`を設定**（実装済み）
   - Embedding層のパラメータ自体に`requires_grad=True`を設定
   - これにより、embedding層の出力が確実に勾配計算グラフに接続される
   - 実装箇所: `scripts/training/train_borea_phi35_so8t_thinking.py` Lines 1089-1099

3. **LoRAパラメータの確認**（実装済み）
   - `get_peft_model`の後に、LoRAパラメータの`requires_grad`を確認
   - `requires_grad=False`の場合は、手動で`requires_grad=True`を設定
   - 実装箇所: `scripts/training/train_borea_phi35_so8t_thinking.py` Lines 1079-1087

## 作成・変更ファイル
- `scripts/training/train_borea_phi35_so8t_thinking.py`: Forward hookの実装、`past_key_values`警告の処理、エラーハンドリングの改善

## 設計判断
1. **Forward Hookの使用**: Embedding層の出力に`requires_grad=True`を設定する試みとしてforward hookを使用。ただし、これだけでは不十分な場合があるため、フォールバック処理も実装。
2. **`past_key_values`警告の処理**: 訓練時には`past_key_values`は使用されないため、`use_cache=False`と`past_key_values=None`を明示的に設定して警告を回避。
3. **エラーハンドリング**: Forward hookが機能しなかった場合のフォールバック処理を実装し、より詳細なログ出力を追加。
4. **SO(8)群構造パラメータの維持**: SO(8)群の回転行列パラメータ（`rotation_params`, `rotation_angles`など）は学習可能パラメータとして維持する必要がある。PEFT LoRAの`target_modules`に含まれないため、手動で`requires_grad=True`を設定する。
5. **Embedding層パラメータの設定**: Embedding層のパラメータ自体に`requires_grad=True`を設定することで、embedding層の出力が確実に勾配計算グラフに接続される。
6. **LoRAパラメータの確認**: `get_peft_model`の後に、LoRAパラメータの`requires_grad`を確認し、`requires_grad=False`の場合は手動で`requires_grad=True`を設定する。

## テスト結果
- リンターエラー: Markdownフォーマット警告のみ（コード動作に影響なし）
- 実装完了: 
  - Forward hookの実装（Lines 339-405）
  - `past_key_values`警告の処理（Lines 388-395）
  - エラーハンドリングの改善（Lines 534-568）
  - Embedding層パラメータの`requires_grad`設定（Lines 1089-1099）
  - LoRAパラメータの`requires_grad`確認と設定（Lines 1079-1087）
  - SO(8)群構造パラメータの`requires_grad`設定（Lines 1101-1112）
- **動作確認**: [未確認] - 再学習を実行して動作確認が必要

## 運用注意事項

### データ収集ポリシー
- 利用条件を守りつつ、高信頼ソースとして優先使用
- robots.txt遵守を徹底
- 個人情報・機密情報の除外を徹底

### NSFWコーパス運用
- **主目的**: 安全判定と拒否挙動の学習（生成目的ではない）
- モデル設計とドキュメントに明記
- 分類器は検出・拒否用途のみ

### /thinkエンドポイント運用
- 四重Thinking部（`<think-*>`）は外部非公開を徹底
- `<final>`のみ返す実装を維持
- 監査ログでThinkingハッシュを記録（内容は非公開）
